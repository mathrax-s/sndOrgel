;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;PIC????????+????ver5_7
;???????????????????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;????
;1.??????3???????4????????PIC16F??????????CPU????????
;??????
;?3???????????3ch????CPU???????PWM???????????????
;???????
;??????????????PWM???3?(96us)????4?(128us)??????
;??????????????5KHz????4KHz???????????
;2.???7????PCM????????????65k?????????????????????????????
;??????????1???????????????????????????????????
;??????
;???????????????????16????????8??????????????????????
;?????????
;3.???125Hz?2KHz(4??????)????????31???????
;???????????????????????????
;4.???32??????????????3????????????7???
;???????????????????????????
;5.???????????????
;6.?????????7????PCM????????????256??????????
;?1?????????????????????????????????????
;?????????????0???????????????????
;??????????????????????????????
;7.?????????????
;8.??????????7????PCM????????????256??????????
;?????????????7????????
;?1??????????????????????????????????????
;??????????????0???????????????????
;???????????????????????????????
;9.??????2????????
;10.???????255?/?????????
;11.?????3ch??????3???????????
;12.?????????????????????I2C????EEPROM?SD??????????????
;?????????????7????PCM??????????????65k?????×63????
;?????????????????????
;????I2C?????8????PCM??????????????65k?????×63????
;??????????????????????????65536??????????????
;????I2C?????I2C?7?????????????????112??????
;????????????????????????????
;?SD?????????8????PCM??????????????2G??????63????
;?????????????????????
;13.??????????????????????????
;
;??????
;(1)????
;1.??????????????????????????????????1??PWM?????
;??????
;2.??2KHz????5?????????????????10KHz?????????
;?100us????
;????DA?????????????????50us???????????
;???????????????????80us???????????????????
;????????????????
;3.??????????????????8KHz?????125us??????????????????
;???????????????????
;4.PWM???????????????
;?TMR????=8MHz?PWM????=256????PWM???32us?????31KHz????
;5.PWM?????????8????????CCPRxL??)????????????????????
;6.PIC16?????????????????????????????11us?????
;?PWM???32us???????????????????????????PWM???
;?2??64us????
;7.????????PWM???4??128us???125us?????????????
;8.????????CPU??????????CCPRxL????????????????????????
;???????????????????
;9.?????????????????????1???????????????????????
;??????????
;10.???????????????????????%???????
;??????????????????????????????
;???????????????????????????255???????????????????
;?????????????????
;?????????????(PWM??????)????????????
;a.??????????(8????)?vel_mac????????????????????
;b.vel_mac??????????????(8????)?PWM??????(8????)????????????????
;c.??????????????(8????)??????
;d.????????????????????????PCM????(7????)???(8????)?????????
;????????????????
;e.?????????PCM?(7????)???(8????)?????????????
;?????????????????????
;f.??????????????(7????PCM)?PWM??????(8????)??????
;g.???????????????????????ch????????
;????????????????????????????????????????????????
;?
;(2)????????
;1.???2kHz???????250us????1us????????????0.4%???
;????????
;????125Hz????????4000us????1us????16????????????
;2.???????????????20ms?5s???????????250???8??????????
;?????
;???????????????????????64?????????????????20ms???????????
;?????312us????
;????????(PWM??×??????????=64us)??5????????
;3.????????????????40ms?10s???????????250???8??????
;????????
;????????????????????????128??????????????????40ms????????
;????????312us????
;????????(PWM??×??????????=64us)??5????????
;4.???????????????????????????????2?????
;????3???????????3????????????????????6?
;????
;?8????????????????????32???(=6)????(=192)????
;5.?????100????????????(32????1/6)?12500us????????
;?PWM??×??????????=64us????????195????????
;??????50?200??????390?98????????
;???????????????????????????????7?????????????
;????????????????????
;???????????????????????
;6.????????????????????????????????????????
;???????????????????????????????????????
;
;(3)?????
;1.??????????????????????????????CCPRxL???????????
;2.????????????????????????????????
;3.???????????????????????????????????????????????
;4.?????????????PWM???????????2?????????
;5.PWM??????????????????????????????????????????????
;????????????????????????????????????????
;
;(4)??????
;1.????????????????????????????????????????????
;2.????????????????1????1?????????=????????????=?????????
;3.??????????????????????????????????????????????????
;??????????????
;
;(5)????????
;1.????????????7?????2?????1????????????????
;???(??????)?????????????????????(PIC16??????????????)?
;2.moviw??????256??????????????????????????????????
;??????
;3.????????Page0(0?0x3ff)????????????????????????????
;??????
;4.?????ch??????????????????????????????????????????
;???????????????????????????????
;
;(6)?????????????????????
;1.????????????????????????????????????????????????????????
;??????????????????????
;2.?????????????????????????????
;????????????????????????????????????????
;3.????????????????????????????????????????
;?????????????????????????????????????
;?SFR????????????????
;?SFR????????banksel??????????
;?????????(?????)????????????
;4.??????????????????????????????????????
;????????????????????????????????????call?????????
;5.???????????????????????????????????????????????
;6.?????????????????????????????????????????
;????
;
;(7)??????????????
;1.PWM????????????????/??????????????????????
;
;(8)???????????????
;1.FSR1??????????????????????????FSR0?????????????
;2.??????????????FSR0???????????????????EEPDATA?????
;
;(9)??????????????????
;1.????????????????????????????????????
;????????????????????????????????
;????????????????????????????????
;2.???????????????????????????????????????????
;????????????????
;3.???????????????????????????????????0????
;?0?????????????????????????????????????????
;4.????????????????????????????????????????
;????????
;
;???????????????
;1.???????????????????????PIC12F/16F?17xx/18xx/19xx????
;???????(??????????????????????)
;???????(????????????????????????)
;?Fosc?32MHz??
;?PWM????
;?EEPROM(I2C)????????I2C????????
;?SD????????????SPI????????
;?????????????????????96??????
;????????????????????????2K??????
;
;???????????????
;????????3??????????????5???????????????
;??????=0???????
;??????=0?????????????
;??5??????????????
;0:?????????
;1:?????(?????????????)
;2:?????1????(????????????)
;3:?????1??(?????????????)
;4:?????2????(????????????)
;5:?????2??(?????????????)
;6:????????(?????????????????????vel_mac????????)
;????????0?255?????????????????255???????
;?vel_mac?????????????????????????????????PWM???????????
;????????
;7:?????????????(??????????????????????????env_mac????????)
;???????????????????????????????[us]??????
;?0????????????????????
;8:?????????(??3????????????????????abs_mac??????
;???)
;?????1?255[32???/6]??????
;?????1?25000[0.1Hz]??????
;?????abs_mac?????????????????????????????
;9:??????(??1????????????[%]???)
;10:????????(????????1??????????????)
;11:????????
;12:??????????????(???????????????????????????pit_mac??????
;???)
;?????????????????????????????????[us]??????
;?0?????????????????????
;
;?.I2C?????????
;(1)?????????????
;?24FC256?24FC512?24FC1025?????
;
;(2)?????????
;?????????????????I2C?????????????????????
;?????????????????????????????
;
;(3)????????
;1.I2C???????
;?PIC????I2C??????????????I2C?????????????
;2.?????????????
;????2?????????
;a.I2C?????????????????????????????????????1???
;?????????60us?????
;b.???????1???????????1??????????15us??????????
;??????13us?CPU?????2us????
;?????????????????????????????????????????????????
;?a.?????????????????????????????????????????
;???????????????????60us?PWM??(32us)?2??????????????
;?2?????????????????
;?b.???????????CPU?????2us?????????????????(125us)?
;???????????????????????1????????????????
;???????????????????????????????????????????
;???????????????????????????
;
;?.SD??????????
;(1)?????????????
;1.??? SanDisk256MBminiSD(Ver1) ??????????????????????
;??????????
;2.??????????512????????
;
;(2)???????????????
;1.???????????8????8ksps?PCM??????WAV??????????
;2.SD??FAT???????????????FAT??????????????????????????
;????CPU????????
;3.?????SD?FAT??????????????????????????????????????
;????????????????????????????????PCM?????SD????????
;??????????FAT?????????????????????
;4.????????????????????????????????????????????????????
;5.WAV????????????WAV???????????????????????PCM
;?????????????????????????????????SD???????512?????????
;???????????PCM????????????????512??????????
;
;(3)????????
;1.SDC????
;?????????SDC???????????????????????????
;???????????????????1????????????????????????????
;2.?????????????
;????2?????????
;a.SDC????????????????????????????????????????????(512????)
;??(125us*512=64ms)?????????????600us?????
;b.?????????????1????????????????(512????)???????????1???????
;????12us???????????????10us?CPU?????2us????
;?????????????????????????????????????????????????
;?a.?????????????????????600us/????64ms?1%?????
;?????????????????????????????????????????????
;??????????????????????????????????????????????600us
;??PWM??(32us)?19??????????????19?????????????????
;?b.???????????CPU?????2us?????????????????(125us)?
;???????????????????????1????????????????
;???????????????????????????????????????????
;???????????????????????????


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;????????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;(0)????
;???????/????????????
;???????????????????????????????????????????
;
;(1)?????????(CB_INIT)
;POR??????????1??????????
;?????
;????????????????????
;???????????
;????????????????
;???????????????
;??????
;
;(2)???????(CB_KOYUU)
;???(PLAY_OWN_MS[ms]?)????????
;?????
;??????????????????
;?????????????????????????
;?????????????????????
;?LED??????????????????????
;??????????????sleep???
;?????????reset???
;??????
;
;(3)????????(CB_SONG_END)
;???????????????????
;?????
;?(2)???????(CB_KOYUU)?????????????????
;??????
;
;(4)????????(CB_VOICEn_END)
;n???ch????0?2???I
;???????????????????
;?????
;?(2)???????(CB_KOYUU)?????????????????
;??????
;
;(5)???????????????(CB_ISR)
;?????
;?????????????????????PWM??????????????????????
;???????????/?????????????
;???????????????10??????????????
;??????


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;???????????????????????API??
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;(0)????
;???????/????????????
;???????API????????
;
;(1)???????(SONG_SEL)
;?? W:???(0=?????1?255=??????????)?
;??????
;
;(2)????????(VOICEn_SEL)
;n???ch????0?2?I???S
;?? W:????(0=?????1?63=???????????)?
;??????
;
;(3)??????????(MUTE_SET)
;?? W:???????
;??????
;
;(4)???????????????????(BUF_CHK)
;?????
;??? W:?????????????


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;??????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;(1)???????????
;1.??????????????????????????????????????????
;??????0(0x800)????????????????PCLATH??????????
;??????0???????256????????????PCM??PWM?????????
;??????1?????????
;2.???????????????0??????PCLATH???????????????
;??????????????????????????????
;3.?????????????CLATH????????????????????????
;????????????
;
;(2)????????????
;1.????????3???????????????????????
;a.main+????+????????+???????????????????????
;??????0????????????0???????????????
;b.??PCM??PWM????????????1.??????????????
;??????
;c.????????????2.???????????????????
;2.????????????????PCLATH?????????PCLATH????
;3.????????????????????????pagesel???????????????
;????????????????????????????????????????


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;(1)??????????
;1.??????????????????????????????????????????
;?????0(0x80)?????????????????????????????BSR????
;????????
;2.??????????????0??????BSR??????????
;3.????????????banksel??????????????????????
;????????????????????????
;
;(2)???????????
;1.????????5???????????????????????
;a.PIC?SRAM?????????????????????????????
;??????????????????????????
;b.????????????+?????????????????????????????0???????
;?????0???????????????
;c.???????????????(?????????????????????????????????)?
;??????????????????
;d.???????+???????????????????????
;e.????????????????????
;3.???????????????????????????????????????????????
;????????????/??????????????
;????????banksel????????????????????????????????
;4.?????????????????????????????????????


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;??????????????????/??????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;(1)??????????
;1.???????????????????????????????
;?????????????????????
;2.????????????????
;
;(2)????????????????????????
;1.????????????????????????????
;2.0????????????
;
;(3)???????????????????
;1.???(1)?(2)????PWM????????????????????????
;2.???????????????????????????????????????
;
;(4)????????????
;1.?voice?_no?????????????????
;2.?voice?_no???????????????
;?b7-6??????sts?????
;??11=???(?????????????)???
;??10=?????????????????
;??01=????????????????????????
;????????????0??????
;??00=?????????????????????????
;?b5?b0??????N?????
;??0=??????
;??1?63=????????
;????????????????????VOICE?_SEL????
;?playback?(????????)???????????????????????(???????)
;???????????
;??????????playback?????????????????????????????
;3.sts+N???????????(????)
;?VOICE?_SEL?11+N????
;?playback?????????????????????????????10+N??????
;???????????????????????????????????????????????????
;?00+N???????????playback?????????
;?????????
;?playback??????????????????????????????0??????CB_VOICE?_END?
;?????????????????00+0????
;???????????????0???????????????????
;4.??????/??????????
;??????????????VOICE?_SEL??????????/????????????
;?????I2C????ACK???????????????????????SD??????????(512????)???
;??????????????
;????????/?????????????????????????????VOICE?_SEL????
;?playback???????????????????????????????
;[I2C?????????]
;?VOICEI_SEL????????01+0???????????0??????
;??????????????????01+0????playbackI????
;?playbackI??????????????0???????ACK????????????????
;???????????????????(?????????????????????????????)?
;????????????????0???CB_VOICEI_END??????????????????00+0????
;[I2C????????????]
;?VOICEI_SEL????????11+0??????????????????????(???????)
;?playbackI????????????????????????????????????????????????????
;????(???????)
;?????????????????
;[SD?????????]
;?VOICES_SEL????????01+0????????????0??????
;??????????????????01+0????playbackS???????
;?playbackS???????????????????????????????????????????
;?????????????0?????????????????
;????????????????0???CB_VOICES_END??????????????????00+0????
;[SD????????????]
;?VOICES_SEL????????11+0???????????????????????????(???????)
;?playbackS????????????????????????????????????????????????
;?????????????playbackS????????????????????????????????????
;??????????????????


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;(1)?????????????
;1.???????????????????????????????????????
;2.??????????????????????????????????????
;
;(2)??????????????????
;1.BSR??
;???????????????????BSR??????????????????????????
;??????????????AP?????????????????????
;??????????????????BSR?????
;2.???????
;???????????????????????????????????????CALLCNV????????????
;3.W???????
;??????????/?????????AP?????????????W???????????
;????????W??????????????????????????W??????????
;4.????????????????????????
;???????????????????????????????????W??????????
;?SFR????????????????????????SFR??W??????????
;?W???????SFR?????????????????W?????????????



;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;??????CALL?????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;????????voice7_cnv?voice_cnv?outpt?outpth??????
#if CNV_PAGE>=0x800
CALLCNV		macro	label			;?????????
		pagesel	label
		call	label
		pagesel	0
		endm
#else
CALLCNV		macro	label			;?????????
		call	label
		endm
#endif

;?????????????????????????
#if (CNV_PAGE>=0x800)|(KOYUU_PAGE>=0x800)
CALLCB		macro	label			;??????????????
		pagesel	label
		call	label
		pagesel	0
		endm

#else
CALLCB		macro	label			;??????????????
		call	label
		endm
#endif

;???????????API??????
#if (CNV_PAGE>=0x800)|(KOYUU_PAGE>=0x800)
CALLAPI		macro	label			;API???????
		pagesel	0
		call	label
		pagesel	$
		endm
#else
CALLAPI		macro	label			;API???????
		call	label
		endm
#endif


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;???????????????
;???????:????????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
ptr_mac		macro	ptr			;??????
		dt	low(ptr)		;?????(??)
		dt	high(ptr)		;?????(??)
		endm


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????????????
;???????:????????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
son_mac		macro	sss,ddd			;??????????(??????),def??????
		dt	low(sss)		;?????(??)
		dt	high(sss)		;?????(??)
#define ddd
		endm
SONG_IDX	equ	2


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????????(VOICE_N?)?????
;??????????PWM???????????????????
;???????????????????????????????????????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
von_mac		macro	aaa,www,sss		;??????????????????????????????????[sps]
		dt	low(aaa)		;????????????????(??)
		dt	high(aaa)		;????????????????(??)
		dt	low(www)		;????????????(??)
		dt	high(www)		;????????????(??)
		dt	(10000/PWM_PR*1000/sss+5)/10
						;?????????PWM??????????????
		endm
VOICE_N_IDX	equ	5





;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;???????????????
;?????????????????????????4????1/48????
;???????????????????????????
;??=60*1000000us/TEMPO/48/(PWM_PR*SONG_PS*TEMPO_PS)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
ps_mac		macro
		dt	(1000000/TEMPO*100/PWM_PR/SONG_PS/TEMPO_PS/8+5)/10
		endm

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;????????????????????????
;?(??????????????*???????????????)??????????????????????????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
eps_mac		macro	eee			;????????????[us/(??????????????*???????????????)]
		dt	(10*eee/PWM_PR/SONG_PS+5)/10
		endm

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????????????????????????
;?(???????????????*????????????????)??????????????????????????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
pps_mac		macro	ppp			;?????????????[us/(????????????*????????????????)]
		dt	(10*ppp/PWM_PR/SONG_PS+5)/10
		endm

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;???????(???/??????)??????
;???????:???[0.1Hz]
;????[1/256]=??????????????[1/256]*???*??????
;??=ONGEN_S[1/256]/256*(f[0.1Hz]/10*KEYTRNS[%]/100)*(PWM_PR[us]/1000000*SONG_PS)*256
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
on_mac		macro	fff			;??????[0.1Hz]
		dw	(fff*KEYTRNS/100*ONGEN_S/256*PWM_PR*SONG_PS/100*256/10000+5)/10
		endm

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????????????
;???????:??[32???/6]
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
cho_mac		macro	ccc			;???
		dt	ccc
		endm

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;????????
;???????:?????????????????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
jmp_mac		macro	jmp			;???
		dt	0x01
		dt	jmp
		endm

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????1???????
;???????:?????1??
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
rp1_mac		macro	rep1			;?????1??
		dt	0x02
		dt	rep1
		endm

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????1?????
;???????:?????1?????????????????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
jp1_mac		macro	jmp1			;?????1???
		dt	0x03
		dt	jmp1
		endm

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????2???????
;???????:?????2??
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
rp2_mac		macro	rep2			;?????2??
		dt	0x04
		dt	rep2
		endm

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????2?????
;???????:?????2?????????????????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
jp2_mac		macro	jmp2			;?????2???
		dt	0x05
		dt	jmp2
		endm

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;???????????
;???????:???????(?????????255????????0????255???)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
vel_mac		macro	vel			;?????????
		dt	0x06
		dt	((PWM_CT-1)*ORGEL_VOL*vel/2550+5)/10
		endm

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;????????????????
;???????:???????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
env_mac		macro	ddd			;??????????????
		dt	0x07
		dt	(ddd*1000/TEMPO+5)/10
		endm

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;??????????????
;???????
;??ccc:???([32???/6])
;??fff:???(???[0.1Hz])
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
abs_mac		macro	ccc,fff			;?????
		dt	0x08
		dt	ccc
		dt	low((fff*KEYTRNS/100*ONGEN_S/256*PWM_PR*SONG_PS/100*256/10000+5)/10)
		dt	high((fff*KEYTRNS/100*ONGEN_S/256*PWM_PR*SONG_PS/100*256/10000+5)/10)
		endm

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????????
;???????:???????[%]
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
tmp_mac		macro	ttt			;???????
		dt	0x09
		dt	((100000/TEMPO*100/PWM_PR/SONG_PS/TEMPO_PS/8)*1000/ttt+5)/10
		endm

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
tss_mac		macro
		dt	0x0a
		endm

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
tse_mac		macro
		dt	0x0b
		endm

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????????????????
;???????:????????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
pit_mac		macro	ddd			;???????????????
		dt	0x0c
		dt	(ddd*1000/TEMPO+5)/10
		endm

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
onp_mac		macro	onka,onkou
		dt	onka*32+onkou
		endm





;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
ONKA_FULL_BIT	equ	7			;?????????????????
STS_PART0_BIT	equ	0			;????0??????????
STS_PART1_BIT	equ	1			;????1??????????
STS_PART2_BIT	equ	2			;????2??????????
PART_TIE_BIT	equ	0			;????????????????
PART_ON_BIT	equ	1			;????????????????
VO_STS0_BIT	equ	7			;??????????????????
VO_STS1_BIT	equ	6			;??????????????????????
VO_STS_MSK	equ	((1<<VO_STS0_BIT)|(1<<VO_STS1_BIT))
						;?????????????
MUTE_VO0_BIT	equ	0			;????????0??????
MUTE_VO1_BIT	equ	1			;????????1??????
MUTE_VO2_BIT	equ	2			;????????2??????
MUTE_ORGEL_BIT	equ	7			;??????????????????


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;??????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;??
	cblock	KYO_BANK			;?????????????
		out_zan				;????????????
		out_buf_r			;????????????????
		out_buf_w			;????????????????
		out_buf:OUT_BUF_N		;???????
		out_buf_end:0			;???????????
		koyuu_psL			;???????????????(??)
		koyuu_psH			;???????????????(??)
	endc

;???????
#ifdef SHDBG
	cblock
		dbg_h				;16??????
	endc
#endif


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;??????/?????????(?????????????????????????????????)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	cblock	CMN_BANK			;??????/????????????????
		mul_a				;??1
		mul_b				;??2
		mul_cH				;?(??)
		mul_cL				;?(??)
		mul_wk				;???
		mute_sts			;????(????1/2???)????
						;b7:????????????(0=????1=??)
						;b6:??chI??????(0=????1=??)
						;b5:??chS??????(0=????1=??)
						;b2:??ch2??????(0=????1=??)
						;b1:??ch1??????(0=????1=??)
						;b0:??ch0??????(0=????1=??)
		api_bsr				;API??BSR???
	endc

#if PART_N>0
;????????
	cblock
		song_no				;???(0=?????1?255=???????)
	endc
#endif

#if VOICE_N>0
;??0??
	cblock
		voice0_no			;???????????
						;?b7-6:??????
						;??11=???(?????????????)???
						;??10=?????????????????
						;??0x=?????????????????????????
						;?b5-0:????(0=???????1?63=????????)
	endc
#endif
#if VOICE_N>1
;??1??
	cblock
		voice1_no			;???????????
						;?b7-6:??????
						;??11=???(?????????????)???
						;??10=?????????????????
						;??0x=?????????????????????????
						;?b5-0:????(0=???????1?63=????????)
	endc
#endif
#if VOICE_N>2
;??2??
	cblock
		voice2_no			;???????????
						;?b7-6:??????
						;??11=???(?????????????)???
						;??10=?????????????????
						;??0x=?????????????????????????
						;?b5-0:????(0=???????1?63=????????)
	endc
#endif


;???????
#ifdef SHDBG
	cblock
		dbg_w				;W????????(?????????)
		dbg_b				;BSR???(?????????)
		dbg_d				;???????????
	endc
#endif


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;????????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
#if PART_N>0
	cblock	ORGEL_BANK			;???????????????????
;??????
		part_su				;???????
		song_ps				;?????????
		song_sts			;????
						;?b7:???????????(0=??1=?)
						;?b2:????2????(0=?????1=???)
						;?b1:????1????(0=?????1=???)
						;?b0:????0????(0=?????1=???)
		onka_psn			;??????????
		onka_ps				;?????????
		tempo_ps			;???????????
		song_out			;?????
		song_pop_ps			;??????????????????????
;????0??
		part0_step			;???????
		part0_onpu			;??????
		part0_sts			;????
						;b1:??/????(0=???1=????)
						;b0:????????(0=??1=?)
		part0_onka_zan			;???????
		part0_repeat			;?????????
						;?b7-4:????2
						;?b3-0:????1
		part0_ongen_nF			;??????????????(1/256?)
		part0_ongen_nL			;??????????????(??)
		part0_ongen_nH			;??????????????(??)
		part0_ongen_tobiF		;????????????(1/256??)
		part0_ongen_tobiL		;????????????(??)
		part0_ongen_ofF			;??????????????????(1/256??)
		part0_ongen_ofL			;??????????????????(??)
		part0_ongen_ofH			;??????????????????(??)
		part0_velo			;?????????
		part0_velo_enve			;?????-?????????????
		part0_enve			;??????????????
		part0_enve_ps			;??????????????????(????????????????????????)
		part0_enve_pss			;??????????????????(??????????????????????)
		part0_enve_n			;?????-??????????????
		part0_enve_of			;?????-?????????????????
		part0_enve_h			;?????-??????????7????
	endc
#if PITCH_N>0
	cblock
		part0_pitch			;???????????????
		part0_pitch_ps			;???????????????????(?????????????????????????)
		part0_pitch_pss			;???????????????????(???????????????????????)
		part0_pitch_n			;?????????????????????
		part0_pitch_of			;????????????????????????
		part0_pitch_h			;?????????????????7????
	endc
#endif
#endif

#if PART_N>1
;????1??
	cblock
		part1_step			;???????
		part1_onpu			;??????
		part1_sts			;????
						;b1:??/????(0=???1=????)
						;b0:????????(0=??1=?)
		part1_onka_zan			;???????
		part1_repeat			;?????????
						;?b7-4:????2
						;?b3-0:????1
		part1_ongen_nF			;??????????????(1/256?)
		part1_ongen_nL			;??????????????(??)
		part1_ongen_nH			;??????????????(??)
		part1_ongen_tobiF		;????????????(1/256??)
		part1_ongen_tobiL		;????????????(??)
		part1_ongen_ofF			;??????????????????(1/256??)
		part1_ongen_ofL			;??????????????????(??)
		part1_ongen_ofH			;??????????????????(??)
		part1_velo			;?????????
		part1_velo_enve			;?????-?????????????
		part1_enve			;??????????????
		part1_enve_ps			;??????????????????(????????????????????????)
		part1_enve_pss			;??????????????????(??????????????????????)
		part1_enve_n			;?????-??????????????
		part1_enve_of			;?????-?????????????????
		part1_enve_h			;?????-??????????7????
	endc
#if PITCH_N>1
	cblock
		part1_pitch			;???????????????
		part1_pitch_ps			;???????????????????(?????????????????????????)
		part1_pitch_pss			;???????????????????(???????????????????????)
		part1_pitch_n			;?????????????????????
		part1_pitch_of			;????????????????????????
		part1_pitch_h			;?????????????????7????
	endc
#endif
#endif

#if PART_N>2
;????2??
	cblock
		part2_step			;???????
		part2_onpu			;??????
		part2_sts			;????
						;b1:??/????(0=???1=????)
						;b0:????????(0=??1=?)
		part2_onka_zan			;???????
		part2_repeat			;?????????
						;?b7-4:????2
						;?b3-0:????1
		part2_ongen_nF			;??????????????(1/256?)
		part2_ongen_nL			;??????????????(??)
		part2_ongen_nH			;??????????????(??)
		part2_ongen_tobiF		;????????????(1/256??)
		part2_ongen_tobiL		;????????????(??)
		part2_ongen_ofF			;??????????????????(1/256??)
		part2_ongen_ofL			;??????????????????(??)
		part2_ongen_ofH			;??????????????????(??)
		part2_velo			;?????????
		part2_velo_enve			;?????-?????????????
		part2_enve			;??????????????
		part2_enve_ps			;??????????????????(????????????????????????)
		part2_enve_pss			;??????????????????(??????????????????????)
		part2_enve_n			;?????-??????????????
		part2_enve_of			;?????-?????????????????
		part2_enve_h			;?????-??????????7????
	endc
#if PITCH_N>2
	cblock
		part2_pitch			;???????????????
		part2_pitch_ps			;???????????????????(?????????????????????????)
		part2_pitch_pss			;???????????????????(???????????????????????)
		part2_pitch_n			;?????????????????????
		part2_pitch_of			;????????????????????????
		part2_pitch_h			;?????????????????7????
	endc
#endif
#endif


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;#if (VOICE_N+VOICE_I+VOICE_S)>0
;;??????
;	cblock	VOICE_BANK			;???????????????
;		voice_pop_ps			;????????????????????
;						;?b6:0=??I?????1=???
;						;?b5:0=??S?????1=???
;						;?b2:0=??2?????1=???
;						;?b1:0=??1?????1=???
;						;?b0:0=??0?????1=???
;		voice_out			;?????
;	endc
;#endif

#if VOICE_N>0
;??0??
	cblock
		voice0_ptL			;???????????????(??)
		voice0_ptH			;???????????????(??)
		voice0_zanL			;????????(??)
		voice0_zanH			;????????(??)
		voice0_data			;??????(????)
		voice0_psn			;????????????
		voice0_ps			;???????????
		voice0_out			;?????
		voice0_pop			;???????????????
	endc
#endif

#if VOICE_N>1
;??1??
	cblock
		voice1_ptL			;???????????????(??)
		voice1_ptH			;???????????????(??)
		voice1_zanL			;????????(??)
		voice1_zanH			;????????(??)
		voice1_data			;??????(????)
		voice1_psn			;????????????
		voice1_ps			;???????????
		voice1_out			;?????
		voice1_pop			;???????????????
	endc
#endif

#if VOICE_N>2
;??2??
	cblock
		voice2_ptL			;???????????????(??)
		voice2_ptH			;???????????????(??)
		voice2_zanL			;????????(??)
		voice2_zanH			;????????(??)
		voice2_data			;??????(????)
		voice2_psn			;????????????
		voice2_ps			;???????????
		voice2_out			;?????
		voice2_pop			;???????????????
	endc
#endif

;#if VOICE_I>0
;;??I2C??
;	cblock
;		mmi2c_slv			;???????????????????(???????????R??????)
;		mmi2c_ad_h			;????????????????????
;		mmi2c_ad_l			;????????????????????
;		mmi2c_len_h			;?????????????????
;		mmi2c_len_l			;?????????????????
;		voiceI_psn			;????????????
;		voiceI_ps			;???????????
;		voiceI_out			;?????
;		voiceI_pop			;???????????????
;	endc
;#endif
;
;#if VOICE_S>0
;;??SD??
;	cblock
;		mmsd_ad0			;SD???????????????0(MSB)
;		mmsd_ad1			;SD???????????????1
;		mmsd_ad2			;SD???????????????2(LSB)b0???0
;		mmsd_len0			;SD???????????0(MSB)
;		mmsd_len1			;SD???????????1
;		mmsd_len2			;SD???????????2(LSB)
;		mmsd_rct			;SD????????
;		mmsd_res			;SD??????
;		mmsd_bct_h			;SD?????????????????????????
;		mmsd_bct_l			;SD?????????????????????????
;		voiceS_psn			;????????????
;		voiceS_ps			;???????????
;		voiceS_out			;?????
;		voiceS_pop			;???????????????
;	endc
;#endif


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	cblock	0
		PTR_L				;?????(??)
		PTR_H				;?????(??)
	endc


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;??????(??)????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	cblock	0
		WAVE_N_F			;????????????(1/256?)
		WAVE_N_L			;????????????(??)
		WAVE_N_H			;????????????(??)
		WAVE_DATA			;??????(7????PCM×2???=?????=??)
	endc


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;??????(??????????????????)????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	cblock	0
		ENVE_N				;????????????
		ENVE_DATA			;??????(7????PCM×2???=?????=??)
	endc


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;????????????????(??n)????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	cblock	0
		HDR_VOn_PT_L			;???????????????(??)
		HDR_VOn_PT_H			;???????????????(??)
		HDR_VOn_LN_L			;???????????(??)
		HDR_VOn_LN_H			;???????????(??)
		HDR_VOn_PSN			;????????????????
		HDR_VOn_size:0
	endc


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;????????????????(??I)????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	cblock	0
		HDR_VOI_PT_L			;???????????????(??)
		HDR_VOI_PT_H			;???????????????(??)
		HDR_VOI_LN_L			;???????????(??)
		HDR_VOI_LN_H			;???????????(??)
		HDR_VOI_PSN			;????????????????
		HDR_VOI_PT_C			;????????????
		HDR_VOI_size:0
	endc


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;????????????????(??S)????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	cblock	0
		HDR_VOS_AD0			;???????????0(b31-24)
		HDR_VOS_AD1			;???????????1(b23-16)
		HDR_VOS_AD2			;???????????2(b15-8)
		HDR_VOS_LEN0			;????????????0(b23-16)
		HDR_VOS_LEN1			;????????????1(b15-8)
		HDR_VOS_LEN2			;????????????2(b7-0)
		HDR_VOS_PSN			;????????????????
		HDR_VOS_size:0
	endc


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????????????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	cblock	0
;??????
		HDR_ONKA_PS			;????????????
		HDR_PART_SU			;???????
;????0??
		HDR_PART0_ONPU_L		;????????????(??)
		HDR_PART0_ONPU_H		;????????????(??)
		HDR_PART0_ONKOU_L		;????????????(??)
		HDR_PART0_ONKOU_H		;????????????(??)
		HDR_PART0_ONKA_L		;????????????(??)
		HDR_PART0_ONKA_H		;????????????(??)
		HDR_PART0_ONGEN_L		;????????????(??)
		HDR_PART0_ONGEN_H		;????????????(??)
		HDR_PART0_ENVE_PS		;??????????????????
		HDR_PART0_ENVE_L		;??????????????????(??)
		HDR_PART0_ENVE_H		;??????????????????(??)
	endc
#if PITCH_N>0
	cblock
		HDR_PART0_PITCH_PS		;???????????????????
		HDR_PART0_PITCH_L		;???????????????????(??)
		HDR_PART0_PITCH_H		;???????????????????(??)
	endc
#endif
	cblock
;????1??
		HDR_PART1_ONPU_L		;????????????(??)
		HDR_PART1_ONPU_H		;????????????(??)
		HDR_PART1_ONKOU_L		;????????????(??)
		HDR_PART1_ONKOU_H		;????????????(??)
		HDR_PART1_ONKA_L		;????????????(??)
		HDR_PART1_ONKA_H		;????????????(??)
		HDR_PART1_ONGEN_L		;????????????(??)
		HDR_PART1_ONGEN_H		;????????????(??)
		HDR_PART1_ENVE_PS		;??????????????????
		HDR_PART1_ENVE_L		;??????????????????(??)
		HDR_PART1_ENVE_H		;??????????????????(??)
	endc
#if PITCH_N>1
	cblock
		HDR_PART1_PITCH_PS		;???????????????????
		HDR_PART1_PITCH_L		;???????????????????(??)
		HDR_PART1_PITCH_H		;???????????????????(??)
	endc
#endif
	cblock
;????2??
		HDR_PART2_ONPU_L		;????????????(??)
		HDR_PART2_ONPU_H		;????????????(??)
		HDR_PART2_ONKOU_L		;????????????(??)
		HDR_PART2_ONKOU_H		;????????????(??)
		HDR_PART2_ONKA_L		;????????????(??)
		HDR_PART2_ONKA_H		;????????????(??)
		HDR_PART2_ONGEN_L		;????????????(??)
		HDR_PART2_ONGEN_H		;????????????(??)
		HDR_PART2_ENVE_PS		;??????????????????
		HDR_PART2_ENVE_L		;??????????????????(??)
		HDR_PART2_ENVE_H		;??????????????????(??)
	endc
#if PITCH_N>2
	cblock
		HDR_PART2_PITCH_PS		;???????????????????
		HDR_PART2_PITCH_L		;???????????????????(??)
		HDR_PART2_PITCH_H		;???????????????????(??)
	endc
#endif


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
		org	0			;??????????
		goto	main			;??????????????


		org	4			;???????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;PWM???????
		banksel	PIRxPWM			;BANK??
		btfss	PIRxPWM,PIRxPWMf	;PWM??????????
#ifdef ISR1				;????????1??????
		goto	intsr8			;???
#else
		retfie				;????????????
#endif
		bcf	PIRxPWM,PIRxPWMf	;PWM?????????????

;PWM????????
		banksel	KYO_BANK		;???????BANK??
		movfw	out_buf_r		;?????????
		movwf	FSR0L			;?FSR?????
		incf	out_buf_r,W		;??????????????
		xorlw	out_buf_end		;??????????
		btfsc	STATUS,Z		;?????
		movlw	out_buf^out_buf_end	;????
		xorlw	out_buf_end		;???
		xorwf	out_buf_w,W		;?????????
		btfsc	STATUS,Z		;???????
		retfie				;???????
		xorwf	out_buf_w,W		;?????????
		movwf	out_buf_r		;???????
		clrf	FSR0H			;FSR????????0???
		movfw	INDF0			;CCP????????
		banksel	PWMxDC			;BANK??
		movwf	PWMxDC			;CCP???????????????

;???????????????
		banksel	KYO_BANK		;???????BANK??
		movf	out_zan,F		;?????
		btfss	STATUS,Z		;?0??????
		decf	out_zan,F		;?-1??

;????????0(PWM??????????)
#ifdef ISR0				;????????0??????
		CALLCB	CB_ISR0			;????????0???
#endif
		retfie				;???????????

;????????1(PWM???????)
#ifdef ISR1				;????????1??????
intsr8
		CALLCB	CB_ISR1			;????????1???
#endif
		retfie				;???????????


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;25ms??
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
WAIT_25mS	clrf	mul_cH			;25ms??
		clrf	mul_cL
		decfsz	mul_cL,F
		goto	$-1
		clrwdt				;??????????
		decfsz	mul_cH,F
		goto	$-3
		return


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;???????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????????????
main		movlw	low(LINEAR_BGN)		;????????
		movwf	FSR0L			;?????????????????
		movlw	high(LINEAR_BGN)
		movwf	FSR0H
		movlw	low(LINEAR_LEN)		;???
		movwf	COMMON_BGN		;???????????
		movlw	high(LINEAR_LEN)+1	;decfsz????????+1????
		movwf	COMMON_BGN+1
		movf	COMMON_BGN,F
		btfsc	STATUS,Z
		decf	COMMON_BGN+1,F
main1		clrf	INDF0			;SRAM??????
		incfsz	FSR0L,F			;?????????
		decf	FSR0H,F
		incf	FSR0H,F
		decfsz	COMMON_BGN,F		;????????
		goto	main1
		decfsz	COMMON_BGN+1,F
		goto	main1

;????????????????
		movlw	COMMON_BGN		;????????
		movwf	FSR0L			;?????????????????
		clrf	FSR0H
		movlw	COMMON_LEN		;?????????????
main2		clrf	INDF0			;SRAM??????
		incf	FSR0L,F			;?????????
		addlw	-1			;????????
		btfss	STATUS,Z
		goto	main2

;??????????
		banksel	KYO_BANK		;???????BANK??
		movlw	out_buf
		movwf	out_buf_w
		movwf	out_buf_r
		bsf	koyuu_psL,0		;????????
		bsf	koyuu_psH,0		;????????????????

;????????????????
#if PART_N>0
		banksel	ORGEL_BANK		;?????????????BANK??
		bsf	song_ps,0		;?????????????????
#endif

;????????????
;#if VOICE_N+VOICE_I+VOICE_S>0
;		banksel	VOICE_BANK		;?????????BANK??
;		bsf	voice_pop_ps,0		;??????????????????????????
;#endif
#if VOICE_N>0
		bsf	voice0_ps,0		;VOICE0???????????????
#endif
#if VOICE_N>1
		bsf	voice1_ps,0		;VOICE1???????????????
#endif
#if VOICE_N>2
		bsf	voice2_ps,0		;VOICE2???????????????
#endif
;#if VOICE_I>0
;		bsf	voiceI_ps,0		;VOICEI???????????????
;#endif
;#if VOICE_S>0
;		bsf	voiceS_ps,0		;VOICES???????????????
;#endif

;???????
		CALLCB	CB_INIT			;???????(?????????)???

;SDC?????(?????????????????????????)
;#if VOICE_S>0
;main3
;	;DEG_L	'i'
;		call	mmsd_init		;SDC??????
;	;DEG_W
;		xorlw	0			;?????
;		btfss	STATUS,Z		;??????
;		goto	main3			;???????
;	;DEG_L	'|'
;#endif

;???????????

;????????
		banksel	KYO_BANK		;???????BANK??
main4		decfsz	koyuu_psL,F		;????????????????????
		goto	main6
		decfsz	koyuu_psH,F		;????????????????????
		goto	main6
		movlw	low(KOYUU_PS)+1		;???????????????
		movwf	koyuu_psL		;?????
		movlw	high(KOYUU_PS)+1	;decfsz???????
		movwf	koyuu_psH		;???+1????
		CALLCB	CB_KOYUU		;?????(?????????)???
main6

;#if VOICE_N+VOICE_I+VOICE_S>0
;;???????
;		banksel	VOICE_BANK		;?????????BANK??
;		decfsz	voice_pop_ps,F		;???????????????????????
;		goto	main20			;???
;		movlw	POP_PS			;????????????????????
;		movwf	voice_pop_ps		;????????
;main20
;#endif

#if VOICE_N>0
;??0????
		movf	voice0_no,F		;??????
		btfsc	STATUS,Z		;??????
		goto	main26			;??????????
		btfsc	voice0_no,VO_STS0_BIT	;?????????????
		goto	main23			;???
		btfsc	voice0_no,VO_STS1_BIT	;????????????????
		goto	main24			;???
		decfsz	voice0_ps,F		;??????????????????
		goto	main29			;???????
		movfw	voice0_psn		;??????????????
		movwf	voice0_ps		;??????

;??????????
		call	playback0		;???????????
main21		xorlw	1			;???????
		btfsc	STATUS,Z		;??????
		goto	main22			;???
		movfw	voice_out		;??????????
		movwf	voice0_out		;?????????
		goto	main28
main22		clrf	voice0_no		;??????????
		CALLCB	CB_VOICE0_END		;???????????????????
		goto	main28

;???????????????
main23		call	playback0		;????????????
		bcf	voice0_no,VO_STS0_BIT	;???????????????
		btfss	voice0_no,VO_STS1_BIT	;?????????????????
		goto	main21			;???????????
		movfw	voice_out		;??????????
		movwf	voice0_pop		;???????????????????

;????????????/??
main24		decfsz	voice_pop_ps,W		;???????????????????
		goto	main28			;?????????
		movfw	voice0_out		;????
		subwf	voice0_pop,W		;???????????????
		btfss	STATUS,Z		;????????
		goto	main25			;???
		bcf	voice0_no,VO_STS1_BIT	;????????????
		goto	main28
main25		movlw	1			;?????????????
		btfss	STATUS,C		;????????????????????????
		movlw	-1			;??????????
		addwf	voice0_out,F		;???????????
		goto	main28

;????????????
main26		movf	voice0_out,F		;????
		btfsc	STATUS,Z		;?????????
		goto	main29			;???
		decfsz	voice_pop_ps,W		;???????????????????
		goto	main28			;?????????
		decf	voice0_out,F		;???????????
main28
		banksel	KYO_BANK		;???????BANK??
		movlw	OUT_BUF_N		;????????
		movwf	out_zan			;?????????
		banksel	VOICE_BANK		;?????????BANK??
main29
#endif

#if VOICE_N>1
;??1????
		movf	voice1_no,F		;??????
		btfsc	STATUS,Z		;??????
		goto	main36			;??????????
		btfsc	voice1_no,VO_STS0_BIT	;?????????????
		goto	main33			;???
		btfsc	voice1_no,VO_STS1_BIT	;????????????????
		goto	main34			;???
		decfsz	voice1_ps,F		;??????????????????
		goto	main39			;???????
		movfw	voice1_psn		;??????????????
		movwf	voice1_ps		;??????

;??????????
		call	playback1		;???????????
main31		xorlw	1			;???????
		btfsc	STATUS,Z		;??????
		goto	main32			;???
		movfw	voice_out		;??????????
		movwf	voice1_out		;?????????
		goto	main38
main32		clrf	voice1_no		;??????????
		CALLCB	CB_VOICE1_END		;???????????????????
		goto	main38

;???????????????
main33		call	playback1		;????????????
		bcf	voice1_no,VO_STS0_BIT	;???????????????
		btfss	voice1_no,VO_STS1_BIT	;?????????????????
		goto	main31			;???????????
		movfw	voice_out		;??????????
		movwf	voice1_pop		;???????????????????

;????????????/??
main34		decfsz	voice_pop_ps,W		;???????????????????
		goto	main38			;?????????
		movfw	voice1_out		;????
		subwf	voice1_pop,W		;???????????????
		btfss	STATUS,Z		;????????
		goto	main35			;???
		bcf	voice1_no,VO_STS1_BIT	;????????????
		goto	main38
main35		movlw	1			;?????????????
		btfss	STATUS,C		;????????????????????????
		movlw	-1			;??????????
		addwf	voice1_out,F		;???????????
		goto	main38

;????????????
main36		movf	voice1_out,F		;????
		btfsc	STATUS,Z		;?????????
		goto	main39			;???
		decfsz	voice_pop_ps,W		;???????????????????
		goto	main38			;?????????
		decf	voice1_out,F		;???????????
main38
		banksel	KYO_BANK		;???????BANK??
		movlw	OUT_BUF_N		;????????
		movwf	out_zan			;?????????
		banksel	VOICE_BANK		;?????????BANK??
main39
#endif

#if VOICE_N>2
;??2????
		movf	voice2_no,F		;??????
		btfsc	STATUS,Z		;??????
		goto	main46			;??????????
		btfsc	voice2_no,VO_STS0_BIT	;?????????????
		goto	main43			;???
		btfsc	voice2_no,VO_STS1_BIT	;????????????????
		goto	main44			;???
		decfsz	voice2_ps,F		;??????????????????
		goto	main49			;???????
		movfw	voice2_psn		;??????????????
		movwf	voice2_ps		;??????

;??????????
		call	playback2		;???????????
main41		xorlw	1			;???????
		btfsc	STATUS,Z		;??????
		goto	main42			;???
		movfw	voice_out		;??????????
		movwf	voice2_out		;?????????
		goto	main48
main42		clrf	voice2_no		;??????????
		CALLCB	CB_VOICE2_END		;???????????????????
		goto	main48

;???????????????
main43		call	playback2		;????????????
		bcf	voice2_no,VO_STS0_BIT	;???????????????
		btfss	voice2_no,VO_STS1_BIT	;?????????????????
		goto	main41			;???????????
		movfw	voice_out		;??????????
		movwf	voice2_pop		;???????????????????

;????????????/??
main44		decfsz	voice_pop_ps,W		;???????????????????
		goto	main48			;?????????
		movfw	voice2_out		;????
		subwf	voice2_pop,W		;???????????????
		btfss	STATUS,Z		;????????
		goto	main45			;???
		bcf	voice2_no,VO_STS1_BIT	;????????????
		goto	main48
main45		movlw	1			;?????????????
		btfss	STATUS,C		;????????????????????????
		movlw	-1			;??????????
		addwf	voice2_out,F		;???????????
		goto	main48

;????????????
main46		movf	voice2_out,F		;????
		btfsc	STATUS,Z		;?????????
		goto	main49			;???
		decfsz	voice_pop_ps,W		;???????????????????
		goto	main48			;?????????
		decf	voice2_out,F		;???????????
main48
		banksel	KYO_BANK		;???????BANK??
		movlw	OUT_BUF_N		;????????
		movwf	out_zan			;?????????
		banksel	VOICE_BANK		;?????????BANK??
main49
#endif

;#if VOICE_I>0
;;??I????
;	;DEG_L	'm'
;	;DEG_F	voiceI_no
;		movf	voiceI_no,F		;??????
;		btfsc	STATUS,Z		;??????
;		goto	main56			;??????????
;		btfsc	voiceI_no,VO_STS0_BIT	;?????????????
;		goto	main53			;???
;		btfsc	voiceI_no,VO_STS1_BIT	;????????????????
;		goto	main54			;???
;		decfsz	voiceI_ps,F		;??????????????????
;		goto	main59			;???????
;		movfw	voiceI_psn		;??????????????
;		movwf	voiceI_ps		;??????
;
;;??????????
;		call	playbackI		;???????????
;	;DEG_W
;main51		xorlw	1			;???????
;		btfsc	STATUS,Z		;??????
;		goto	main52			;???
;	;DEG_F	voice_out
;		movfw	voice_out		;??????????
;		movwf	voiceI_out		;?????????
;		goto	main58
;main52		movlw	~VO_STS_MSK		;?????
;		andwf	voiceI_no,W		;?0???????
;		clrf	voiceI_no		;??????????
;		btfsc	STATUS,Z		;?????0??????
;		goto	main58			;??????????????????????
;		CALLCB	CB_VOICEI_END		;???????????????????
;		goto	main58
;
;;???????????????
;main53		call	playbackI		;????????????
;		bcf	voiceI_no,VO_STS0_BIT	;???????????????
;		btfss	voiceI_no,VO_STS1_BIT	;?????????????????
;		goto	main51			;???????????
;	;DEG_L	'p'
;	;DEG_W
;		movfw	voice_out		;??????????
;		movwf	voiceI_pop		;???????????????????
;
;;????????????/??
;main54		decfsz	voice_pop_ps,W		;???????????????????
;		goto	main58			;?????????
;		movfw	voiceI_out		;????
;	;DEG_F	voiceI_out
;		subwf	voiceI_pop,W		;???????????????
;		btfss	STATUS,Z		;????????
;		goto	main55			;???
;		bcf	voiceI_no,VO_STS1_BIT	;????????????
;		goto	main58
;main55		movlw	1			;?????????????
;		btfss	STATUS,C		;????????????????????????
;		movlw	-1			;??????????
;		addwf	voiceI_out,F		;???????????
;		goto	main58
;
;;????????????
;main56		movf	voiceI_out,F		;????
;		btfsc	STATUS,Z		;?????????
;		goto	main59			;???
;		decfsz	voice_pop_ps,W		;???????????????????
;		goto	main58			;?????????
;		decf	voiceI_out,F		;???????????
;	;DEG_L	'k'
;	;DEG_F	voiceI_out
;main58
;		banksel	KYO_BANK		;???????BANK??
;		movlw	OUT_BUF_N		;????????
;		movwf	out_zan			;?????????
;						;????????????????????
;main59
;#endif
;
;#if VOICE_S>0
;;??S????
;	;DEG_L	'm'
;	;DEG_F	voiceS_no
;		movf	voiceS_no,F		;??????
;		btfsc	STATUS,Z		;??????
;		goto	main66			;??????????
;		btfsc	voiceS_no,VO_STS0_BIT	;?????????????
;		goto	main63			;???
;		btfsc	voiceS_no,VO_STS1_BIT	;????????????????
;		goto	main64			;???
;		decfsz	voiceS_ps,F		;??????????????????
;		goto	main69			;???????
;		movfw	voiceS_psn		;??????????????
;		movwf	voiceS_ps		;??????
;
;;??????????
;		call	playbackS		;???????????
;	;DEG_W
;main61		xorlw	1			;???????
;		btfsc	STATUS,Z		;??????
;		goto	main62			;???
;	;DEG_F	voice_out
; 		movfw	voice_out		;??????????
;		movwf	voiceS_out		;?????????
;		goto	main68
;main62		movlw	~VO_STS_MSK		;?????
;		andwf	voiceS_no,W		;?0???????
;		clrf	voiceS_no		;??????????
;		btfsc	STATUS,Z		;?????0??????
;		goto	main68			;??????????????????????
;		CALLCB	CB_VOICES_END		;???????????????????
;		goto	main68
;
;;???????????????
;main63		call	playbackS		;????????????
;		xorlw	2			;?????????
;		btfss	STATUS,Z		;??????
;		goto	main68			;???????????
;		bcf	voiceS_no,VO_STS0_BIT	;???????????????
;		btfss	voiceS_no,VO_STS1_BIT	;?????????????????
;		goto	main61			;???????????
;	;DEG_L	'p'
;	;DEG_W
;		movfw	voice_out		;??????????
;		movwf	voiceS_pop		;???????????????????
;
;;????????????/??
;main64		decfsz	voice_pop_ps,W		;???????????????????
;		goto	main68			;?????????
;		movfw	voiceS_out		;????
;	;DEG_F	voiceS_out
;		subwf	voiceS_pop,W		;???????????????
;		btfss	STATUS,Z		;????????
;		goto	main65			;???
;		bcf	voiceS_no,VO_STS1_BIT	;????????????
;		goto	main68
;main65		movlw	1			;?????????????
;		btfss	STATUS,C		;????????????????????????
;		movlw	-1			;??????????
;		addwf	voiceS_out,F		;???????????
;		goto	main68
;
;;????????????
;main66		movf	voiceS_out,F		;????
;		btfsc	STATUS,Z		;?????????
;		goto	main69			;???
;		decfsz	voice_pop_ps,W		;???????????????????
;		goto	main68			;?????????
;		decf	voiceS_out,F		;???????????
;	;DEG_L	'k'
;	;DEG_F	voiceS_out
;main68
;		banksel	KYO_BANK		;???????BANK??
;		movlw	OUT_BUF_N		;????????
;		movwf	out_zan			;?????????
;						;????????????????????
;main69
;#endif

#if PART_N>0
;??????????
		banksel	ORGEL_BANK		;???????????????????
		movf	song_no,F		;????
		btfsc	STATUS,Z		;??????
		goto	main74			;?????????
		decfsz	song_ps,F		;????????????????
		goto	main78			;?????????
		movlw	SONG_PS			;??????????
		movwf	song_ps			;??????
		call	orgel			;?????????
		movf	song_sts,F		;?????????
		btfss	STATUS,Z		;???????????
		goto	main76			;???
		clrf	song_no			;???????
		CALLCB	CB_SONG_END		;?????????????????
		goto	main76

;????????????
main74		movf	song_out,F		;????
		btfsc	STATUS,Z		;?????????
		goto	main78			;???
		decfsz	song_pop_ps,F		;???????????????????
		goto	main78			;?????????
		movlw	POP_PS			;???????????????????
		movwf	song_pop_ps		;??????
		decf	song_out,F		;???????????
main76
		banksel	KYO_BANK		;???????BANK??
		movlw	OUT_BUF_N		;????????
		movwf	out_zan			;?????????

main78
#endif


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;??????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;??????????????
		banksel	KYO_BANK		;???????BANK??
out		movfw	out_buf_w		;?????????
		xorwf	out_buf_r,W		;??????????
		btfsc	STATUS,Z		;??????
		goto	out			;???????????

;????????????????
		movfw	out_buf_w		;???????????????????
		movwf	FSR0L
		clrf	FSR0H

;??????
		clrf	mul_wk			;???????????(????????)
		clrf	mul_a			;????????????????(????????)
#if PART_N>0
		banksel	ORGEL_BANK		;???????????????????
		movfw	song_out		;??????
		btfsc	mute_sts,MUTE_ORGEL_BIT	;??????????
		lsrf	song_out,W		;?1/2???
		addwf	mul_wk,F		;????
#endif
;#if (VOICE_N+VOICE_I+VOICE_S)>0
;		banksel	VOICE_BANK		;?????????BANK??
;#endif
#if VOICE_N>0
		movfw	voice0_out		;??????
		btfsc	mute_sts,MUTE_VO0_BIT	;??????????
		lsrf	voice0_out,W		;?1/2???
		addwf	mul_wk,F		;????
		btfsc	STATUS,C		;??????????
		incf	mul_a,F			;????????????????
#endif
#if VOICE_N>1
		movfw	voice1_out		;??????
		btfsc	mute_sts,MUTE_VO1_BIT	;??????????
		lsrf	voice1_out,W		;?1/2???
		addwf	mul_wk,F		;????
		btfsc	STATUS,C		;??????????
		incf	mul_a,F			;????????????????
#endif
#if VOICE_N>2
		movfw	voice2_out		;??????
		btfsc	mute_sts,MUTE_VO2_BIT	;??????????
		lsrf	voice2_out,W		;?1/2???
		addwf	mul_wk,F		;????
		btfsc	STATUS,C		;??????????
		incf	mul_a,F			;????????????????
#endif
;#if VOICE_I>0
;		movfw	voiceI_out		;??????
;		btfsc	mute_sts,MUTE_VOI_BIT	;??????????
;		lsrf	voiceI_out,W		;?1/2???
;		addwf	mul_wk,F		;????
;		btfsc	STATUS,C		;??????????
;		incf	mul_a,F			;????????????????
;#endif
;#if VOICE_S>0
;		movfw	voiceS_out		;??????
;		btfsc	mute_sts,MUTE_VOS_BIT	;??????????
;		lsrf	voiceS_out,W		;?1/2???
;		addwf	mul_wk,F		;????
;		btfsc	STATUS,C		;??????????
;		incf	mul_a,F			;????????????????
;#endif
		movlw	PWM_CT-1		;?????????????
		movf	mul_a,F			;????????????
		btfss	STATUS,Z		;???????
		goto	out4
		subwf	mul_wk,W		;????
		btfsc	STATUS,C		;?????
		movlw	0			;???????
		addlw	PWM_CT-1		;????????
out4		movwi	0[FSR0]			;???????????
	;DEG_W

;????????????????????
out8
		banksel	KYO_BANK		;???????BANK??
		incf	out_buf_w,W		;??????????????
		xorlw	out_buf_end		;??????????
		btfsc	STATUS,Z		;?????
		movlw	out_buf^out_buf_end	;????
		xorlw	out_buf_end		;???
		movwf	out_buf_w		;?????????????
		goto	main4			;???????????

;???????????


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;????????(API??)
;input W:???????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
MUTE_SET
		movwf	mute_sts		;???????????
		return


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????????????????(API??)
;output W:?????????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
BUF_CHK
		movfw	BSR			;BSR?
		movwf	api_bsr			;?????
		banksel	KYO_BANK		;???????BANK??
		movfw	out_zan			;??????????????
		movwf	mul_wk			;??????????????
		movfw	api_bsr			;BSR?
		movwf	BSR			;?????
		movfw	mul_wk			;????????????????
		return


#if PART_N>0
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????(API??)
;input W:???(0=?????1?255=??????????)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;?????????????
SONG_SEL	xorwf	song_no,W		;????????
		btfsc	STATUS,Z		;???????
		return				;???????
		xorwf	song_no,W		;????????

;??????
		addlw	-1			;????
		btfsc	STATUS,C		;?1??????
		goto	song_sel2		;???

;?????
		movfw	BSR			;BSR?
		movwf	api_bsr			;?????
		banksel	ORGEL_BANK		;???????????????????
		clrf	song_no			;??????????
		clrf	song_sts
		movlw	POP_PS			;???????????????????
		movwf	song_pop_ps		;??????
		movfw	api_bsr			;BSR?
		movwf	BSR			;?????
		return

;??????????
song_sel2
		addlw	1			;????????
		addlw	-((song_tbl_end-song_tbl)/2+1)
						;???????????
		btfsc	STATUS,C		;??????
		return				;???????
		addlw	(song_tbl_end-song_tbl)/2+1
						;????????
		movwf	song_no			;??????????

;?????????
		movfw	BSR			;BSR?
		movwf	api_bsr			;?????
		banksel	ORGEL_BANK		;???????????????????
		clrf	song_sts		;???????????
		movlw	1			;????????????
		movwf	song_ps			;??????

;???????????????????????????FSR1???
		clrf	FSR0H			;??????????
		lslf	song_no,W		;?????????
		movwf	FSR0L			;?FSR0?
		movlw	high(song_tbl-2)	;?????
		addwfc	FSR0H,F
		movlw	low(song_tbl-2)
		addwf	FSR0L,F
		movlw	0
		addwfc	FSR0H,F
		moviw	PTR_L[FSR0]		;??????????????
		movwf	FSR1L			;???????
		moviw	PTR_H[FSR0]		;?FSR1?
		movwf	FSR1H			;?????

;??????????????????
		moviw	HDR_ONKA_PS[FSR1]	;????????????????
		movwf	onka_psn		;??????????????
		moviw	HDR_PART_SU[FSR1]	;?????????????
		movwf	part_su			;???????????
		movlw	1
		movwf	onka_ps			;?????????????????
		movwf	tempo_ps		;???????????????????

;????0????????????
		clrf	part0_step
		clrf	part0_sts
		clrf	part0_ongen_ofF
		clrf	part0_ongen_ofL
		clrf	part0_ongen_ofH
		clrf	part0_enve
		movlw	1
		movwf	part0_onka_zan		;???????????
		bsf	song_sts,STS_PART0_BIT	;???????????

;??????????????
		moviw	HDR_PART0_ONGEN_L[FSR1]	;?????????????????
		movwf	FSR0L
		moviw	HDR_PART0_ONGEN_H[FSR1]
		movwf	FSR0H
		moviw	WAVE_N_F[FSR0]		;??????????????????
		movwf	part0_ongen_nF
		moviw	WAVE_N_L[FSR0]
		movwf	part0_ongen_nL
		moviw	WAVE_N_H[FSR0]
		movwf	part0_ongen_nH

;????????????????????
		moviw	HDR_PART0_ENVE_L[FSR1]	;???????????????????????
		movwf	FSR0L
		moviw	HDR_PART0_ENVE_H[FSR1]
		movwf	FSR0H
		moviw	ENVE_N[FSR0]		;????????????????????????
		movwf	part0_enve_n

#if PITCH_N>0
;?????????????????????
		moviw	HDR_PART0_PITCH_L[FSR1]	;????????????????????????
		movwf	FSR0L
		moviw	HDR_PART0_PITCH_H[FSR1]
		movwf	FSR0H
		moviw	ENVE_N[FSR0]		;?????????????????????????
		movwf	part0_pitch_n
#endif

#if PART_N>1
;????1????????????
		movlw	-2			;?????
		addwf	part_su,W		;?????
		btfss	STATUS,C		;????
		goto	song_sel11		;???
		clrf	part1_step
		clrf	part1_sts
		clrf	part1_ongen_ofF
		clrf	part1_ongen_ofL
		clrf	part1_ongen_ofH
		clrf	part1_enve
		movlw	1
		movwf	part1_onka_zan		;???????????
		bsf	song_sts,STS_PART1_BIT	;???????????

;??????????????
		moviw	HDR_PART1_ONGEN_L[FSR1]	;?????????????????
		movwf	FSR0L
		moviw	HDR_PART1_ONGEN_H[FSR1]
		movwf	FSR0H
		moviw	WAVE_N_F[FSR0]
		movwf	part1_ongen_nF
		moviw	WAVE_N_L[FSR0]		;??????????????????
		movwf	part1_ongen_nL
		moviw	WAVE_N_H[FSR0]
		movwf	part1_ongen_nH

;????????????????????
		moviw	HDR_PART1_ENVE_L[FSR1]	;???????????????????????
		movwf	FSR0L
		moviw	HDR_PART1_ENVE_H[FSR1]
		movwf	FSR0H
		moviw	ENVE_N[FSR0]		;????????????????????????
		movwf	part1_enve_n

#if PITCH_N>1
;?????????????????????
		moviw	HDR_PART1_PITCH_L[FSR1]	;????????????????????????
		movwf	FSR0L
		moviw	HDR_PART1_PITCH_H[FSR1]
		movwf	FSR0H
		moviw	ENVE_N[FSR0]		;?????????????????????????
		movwf	part1_pitch_n
#endif
song_sel11
#endif

#if PART_N>2
;????2????????????
		movlw	-3			;?????
		addwf	part_su,W		;?????
		btfss	STATUS,C		;????
		goto	song_sel21		;???
		clrf	part2_step
		clrf	part2_sts
		clrf	part2_ongen_ofF
		clrf	part2_ongen_ofL
		clrf	part2_ongen_ofH
		clrf	part2_enve
		movlw	1
		movwf	part2_onka_zan		;???????????
		bsf	song_sts,STS_PART2_BIT	;???????????

;??????????????
		moviw	HDR_PART2_ONGEN_L[FSR1]	;?????????????????
		movwf	FSR0L
		moviw	HDR_PART2_ONGEN_H[FSR1]
		movwf	FSR0H
		moviw	WAVE_N_F[FSR0]		;??????????????????
		movwf	part2_ongen_nF
		moviw	WAVE_N_L[FSR0]
		movwf	part2_ongen_nL
		moviw	WAVE_N_H[FSR0]
		movwf	part2_ongen_nH

;????????????????????
		moviw	HDR_PART2_ENVE_L[FSR1]	;???????????????????????
		movwf	FSR0L
		moviw	HDR_PART2_ENVE_H[FSR1]
		movwf	FSR0H
		moviw	ENVE_N[FSR0]		;????????????????????????
		movwf	part2_enve_n

#if PITCH_N>2
;?????????????????????
		moviw	HDR_PART2_PITCH_L[FSR1]	;????????????????????????
		movwf	FSR0L
		moviw	HDR_PART2_PITCH_H[FSR1]
		movwf	FSR0H
		moviw	ENVE_N[FSR0]		;?????????????????????????
		movwf	part2_pitch_n
#endif
song_sel21
#endif
		movfw	api_bsr			;BSR?
		movwf	BSR			;?????
		return
#endif


#if PART_N>0
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;????0?????????
;output W:??????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
part0_get_onpu	moviw	HDR_PART0_ONPU_H[FSR1]	;???????
		movwf	FSR0H			;???????
		moviw	HDR_PART0_ONPU_L[FSR1]	;???
		movwf	FSR0L			;???
		movfw	part0_step		;????????
		addwf	FSR0L,F			;???????
		btfsc	STATUS,C		;?????
		incf	FSR0H,F
		incf	part0_step,F		;?????????????
		moviw	0[FSR0]			;???????????
		return
#endif


#if PART_N>1
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;????1?????????
;output W:??????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
part1_get_onpu	moviw	HDR_PART1_ONPU_H[FSR1]	;???????
		movwf	FSR0H			;???????
		moviw	HDR_PART1_ONPU_L[FSR1]	;???
		movwf	FSR0L			;???
		movfw	part1_step		;????????
		addwf	FSR0L,F			;???????
		btfsc	STATUS,C		;?????
		incf	FSR0H,F
		incf	part1_step,F		;?????????????
		moviw	0[FSR0]			;???????????
		return
#endif


#if PART_N>2
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;????2?????????
;output W:??????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
part2_get_onpu	moviw	HDR_PART2_ONPU_H[FSR1]	;???????
		movwf	FSR0H			;???????
		moviw	HDR_PART2_ONPU_L[FSR1]	;???
		movwf	FSR0L			;???
		movfw	part2_step		;????????
		addwf	FSR0L,F			;???????
		btfsc	STATUS,C		;?????
		incf	FSR0H,F
		incf	part2_step,F		;?????????????
		moviw	0[FSR0]			;???????????
		return
#endif


#if PART_N>0
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;???????????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;????????????????
orgel		bcf	song_sts,ONKA_FULL_BIT	;??????????????????
		decfsz	onka_ps,F		;??????????-1??
		goto	orgel5			;???????????
		movfw	onka_psn		;?????????????
		movwf	onka_ps
		decfsz	tempo_ps,F		;????????????-1??
		goto	orgel5			;???????????
		movlw	TEMPO_PS		;???????????????
		movwf	tempo_ps
		bsf	song_sts,ONKA_FULL_BIT	;??????????????????

;??????????
orgel5		clrf	song_out		;?????????????


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;????0????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
		btfss	song_sts,STS_PART0_BIT	;?????????
		goto	part0_999		;???????????

;?????????????????????
		btfss	song_sts,ONKA_FULL_BIT	;??????????????????
		goto	part0_7			;?????????????
		decfsz	part0_onka_zan,F	;????????-1???????
		goto	part0_7			;??????????????

;???????
part0_1		call	part0_get_onpu		;???????????
		movwf	part0_onpu		;???????????
		
;??????????
		swapf	part0_onpu,F		;????????
		rrf	part0_onpu,W		;????????
		swapf	part0_onpu,F		;????
		andlw	0x07			;???????
		btfsc	STATUS,Z		;?0????
		goto	part0_5			;???????????
		movwf	FSR0L			;????????????
		moviw	HDR_PART0_ONKA_H[FSR1]	;???????
		movwf	FSR0H			;?????
		moviw	HDR_PART0_ONKA_L[FSR1]
		addwf	FSR0L,F
		btfsc	STATUS,C
		incf	FSR0H,F
		moviw	-1[FSR0]		;???????
		movwf	part0_onka_zan		;?????

;??/????????
		movfw	part0_onpu		;???????
		andlw	0x1f			;????????
		btfsc	STATUS,Z		;?0????
		goto	part0_4			;????????
		bsf	part0_sts,PART_ON_BIT	;?????????

;????????????????????????
		addlw	-1			;??????-1??????????????????
		banksel	EEADRL			;BANK??
		movwf	EEADRL
		moviw	HDR_PART0_ONKOU_H[FSR1]	;??????????????????
		movwf	EEADRH
		moviw	HDR_PART0_ONKOU_L[FSR1]
		addwf	EEADRL,F		;???????????????????
		btfsc	STATUS,C
		incf	EEADRH,F
		bcf	EECON1,EECFGS		;Config??????
		bsf	EECON1,EEPGD		;Program???????
		bsf	EECON1,RD		;?????
		nop
		nop
		movfw	EEDATL			;?????????????????
		banksel	ORGEL_BANK		;???????????????????
		movwf	part0_ongen_tobiF
		banksel	EEDATH			;BANK??
		movfw	EEDATH
		banksel	ORGEL_BANK		;???????????????????
		movwf	part0_ongen_tobiL

;???????????
part0_3		btfsc	part0_sts,PART_TIE_BIT	;????????????
		goto	part0_71		;???
		clrf	part0_enve_ps		;???????????
		bsf	part0_enve_ps,0		;??????
		clrf	part0_enve_pss
		bsf	part0_enve_pss,0
		clrf	part0_enve_of
#if PITCH_N>0
		clrf	part0_pitch_ps		;????????????
		bsf	part0_pitch_ps,0	;??????
		clrf	part0_pitch_pss
		bsf	part0_pitch_pss,0
		clrf	part0_pitch_of
#endif
		goto	part0_71		;?????????????

;?????
part0_4		bcf	part0_sts,PART_ON_BIT	;???????
		clrf	part0_velo_enve		;?????-??????????????0???
		goto	part0_999		;??????????

;????????
part0_5		movfw	part0_onpu		;???????
		brw				;?????
		goto	part0_51		;?????
		goto	part0_52		;????????
		goto	part0_53		;?????1???????
		goto	part0_54		;?????1?????
		goto	part0_56		;?????2???????
		goto	part0_57		;?????2?????
		goto	part0_59		;???????????
		goto	part0_6			;????????????????
		goto	part0_61		;????????
		goto	part0_62		;?????????
		goto	part0_63		;???????????
		goto	part0_64		;???????????

;?????????????????
		call	part0_get_onpu		;???????????
#if PITCH_N>0
		movwf	part0_pitch		;????????????????????
#endif
		goto	part0_1			;???????

;?????
part0_51	bcf	song_sts,STS_PART0_BIT	;???????
		goto	part0_999		;??????????

;????????
part0_52	call	part0_get_onpu		;???????????
		movwf	part0_step		;????????????
		goto	part0_1			;???????

;?????1???????
part0_53	movlw	0xf0			;??????????
		andwf	part0_repeat,F		;????????
		call	part0_get_onpu		;???????????
		andlw	0x0f			;????????
		iorwf	part0_repeat,F		;???????????????
		goto	part0_1			;???????

;?????1?????
part0_54	movlw	-1			;?????
		addwf	part0_repeat,F		;?-1??
		movfw	part0_repeat		;?????
		andlw	0x0f			;?0?
		btfsc	STATUS,Z		;?????
		goto	part0_55		;???
		call	part0_get_onpu		;???????????
		movwf	part0_step		;????????????
		goto	part0_1			;???????
part0_55	incf	part0_step,F		;?????????????
		goto	part0_1			;???????

;?????2???????
part0_56	swapf	part0_repeat,F		;?????????????????????
		movlw	0xf0			;??????????
		andwf	part0_repeat,F		;????????
		call	part0_get_onpu		;???????????
		andlw	0x0f			;????????
		iorwf	part0_repeat,F		;???????????????
		swapf	part0_repeat,F		;???????????????????
		goto	part0_1			;???????

;?????2?????
part0_57	swapf	part0_repeat,F		;?????????????????????
		movlw	-1			;?????
		addwf	part0_repeat,F		;?-1??
		movfw	part0_repeat		;?????
		andlw	0x0f			;?0?
		btfsc	STATUS,Z		;?????
		goto	part0_58		;???
		call	part0_get_onpu		;???????????
		movwf	part0_step		;????????????
		swapf	part0_repeat,F		;???????????????????
		goto	part0_1			;???????
part0_58	incf	part0_step,F		;?????????????
		swapf	part0_repeat,F		;???????????????????
		goto	part0_1			;???????

;???????????
part0_59	call	part0_get_onpu		;???????????
		movwf	part0_velo		;??????????????
		goto	part0_1			;???????

;????????????????
part0_6		call	part0_get_onpu		;???????????
		movwf	part0_enve		;???????????????????
		goto	part0_1			;???????

;????????
part0_61	call	part0_get_onpu		;??(?????)?????
		movwf	part0_onka_zan
		call	part0_get_onpu		;?????????????????
		movwf	part0_ongen_tobiF
		call	part0_get_onpu
		movwf	part0_ongen_tobiL
		bsf	part0_sts,PART_ON_BIT	;???????????
		iorwf	part0_ongen_tobiF,W	;?????????????
		btfsc	STATUS,Z		;?0????
		bcf	part0_sts,PART_ON_BIT	;????????
		goto	part0_3			;????????

;?????????
part0_62	call	part0_get_onpu		;????(????????????)?????
		movwf	onka_psn		;???????????????
		goto	part0_1			;???????

;???????????
part0_63	bsf	part0_sts,PART_TIE_BIT	;???????????
		goto	part0_1

;???????????
part0_64	bcf	part0_sts,PART_TIE_BIT	;???????????
		goto	part0_1

;?????????????????
part0_7		btfss	part0_sts,PART_ON_BIT	;??????
		goto	part0_999		;???????????
part0_71	movf	part0_enve,F		;???????????????
		btfss	STATUS,Z		;?0?????
		goto	part0_72		;????????????????
		movfw	part0_velo		;??????????
		movwf	part0_velo_enve		;??????-????????????????
		goto	part0_8

;?????????????????????
part0_72	decfsz	part0_enve_pss,F	;????????????????????????????????????
		goto	part0_8			;???????????????
		movfw	part0_enve		;?????????????????????????????
		movwf	part0_enve_pss		;??????
		decfsz	part0_enve_ps,F		;??????????????????????????????????????
		goto	part0_8			;???????????????
		moviw	HDR_PART0_ENVE_PS[FSR1]	;???????????????????????????????
		movwf	part0_enve_ps		;??????

;????????????
		btfsc	part0_enve_of,0		;??7???????????
		goto	part0_74		;???
		lsrf	part0_enve_of,W		;??????????????????????????????
		banksel	EEADRL			;BANK??
		movwf	EEADRL
		moviw	HDR_PART0_ENVE_H[FSR1]
		movwf	EEADRH
		moviw	HDR_PART0_ENVE_L[FSR1]	;???????????????????????
		addwf	EEADRL,F
		btfsc	STATUS,C
		incf	EEADRH,F
		incf	EEADRL,F		;???????????????
		btfsc	STATUS,Z
		incf	EEADRH,F
		bcf	EECON1,EECFGS		;Config??????
		bsf	EECON1,EEPGD		;Program???????
		bsf	EECON1,RD		;?????
		nop
		nop
		rlf	EEDATL,W		;???b7?C????
		rlf	EEDATH,W		;??+C?W????
		banksel	ORGEL_BANK		;???????????????????
		andlw	0x7f			;????????????????7?????
		movwf	part0_enve_h		;???????
		banksel	EEADRL			;BANK??
		movfw	EEDATL			;??????????????
		andlw	0x7f			;???7?????????
		banksel	ORGEL_BANK		;???????????????????
		goto	part0_76
part0_74	movfw	part0_enve_h		;?????????7???????

;??????????????????????
part0_76	movwf	mul_b			;?????????(7????)?
		movfw	part0_velo
		movwf	mul_a			;??????????(8????)?
		call	mul7_exe		;?????
		movfw	mul_cH			;??15???????8?????
		movwf	part0_velo_enve		;???????????????????????

;??????????????
		incf	part0_enve_of,F		;?????????????????????????
		movfw	part0_enve_of		;???
		xorwf	part0_enve_n,W		;?????
		btfsc	STATUS,Z		;?????
		decf	part0_enve_of,F		;?????

;???????????
part0_8		lsrf	part0_ongen_ofH,W	;????????????????
		banksel	EEADRH			;BANK??
		movwf	EEADRH
		banksel	ORGEL_BANK		;???????????????????
		rrf	part0_ongen_ofL,W
		banksel	EEADRL			;BANK??
		addlw	WAVE_DATA
		movwf	EEADRL			;??????????????????
		btfsc	STATUS,C
		incf	EEADRH,F
		moviw	HDR_PART0_ONGEN_L[FSR1]
		addwf	EEADRL,F		;???????????????????
		btfsc	STATUS,C
		incf	EEADRH,F
		moviw	HDR_PART0_ONGEN_H[FSR1]
		addwf	EEADRH,F
		bcf	EECON1,EECFGS		;Config??????
		bsf	EECON1,EEPGD		;Program???????
		bsf	EECON1,RD		;?????
		nop
		nop
		banksel	ORGEL_BANK		;???????????????????
		btfsc	part0_ongen_ofL,0	;????????????
		goto	part0_82		;???
		banksel	EEDATL			;BANK??
		movfw	EEDATL			;??7?????????
		goto	part0_84
part0_82
		banksel	EEDATL			;BANK??
		rlf	EEDATL,W		;??7?????????
		rlf	EEDATH,W
part0_84	andlw	0x7f

;??????????????????
		banksel	ORGEL_BANK		;???????????????????
		movwf	mul_b			;???????(7????)?
		movfw	part0_velo_enve		;?????????????
		movwf	mul_a			;????????(8????)?
		call	mul7_exe		;?????
		movfw	mul_cH			;??15???????8?????
		addwf	song_out,W		;???????????
		btfsc	STATUS,C		;??????????
		movlw	255			;?????
		movwf	song_out		;?????

;???????????
		movfw	part0_ongen_tobiF	;???????(1/256)??????????
		addwf	part0_ongen_ofF,F
		btfsc	STATUS,C		;??????????
		incfsz	part0_ongen_ofL,F	;???+1??
		decf	part0_ongen_ofH,F	;??????????
		incf	part0_ongen_ofH,F	;????+1??
		movfw	part0_ongen_tobiL	;???
		addwf	part0_ongen_ofL,F	;????
		btfsc	STATUS,C		;???????
		incf	part0_ongen_ofH,F	;????+1??

;????????????????
		movfw	part0_ongen_nH		;???????
		subwf	part0_ongen_ofH,W	;????
		btfss	STATUS,C		;?????????
		goto	part0_88		;???
		btfss	STATUS,Z		;?????????
		goto	part0_86		;???
		movfw	part0_ongen_nL		;??????
		subwf	part0_ongen_ofL,W	;????
		btfss	STATUS,C		;?????????
		goto	part0_88		;???
		movfw	part0_ongen_nF		;??????
		subwf	part0_ongen_ofF,W	;?1/256??
		btfss	STATUS,C		;?????????
		goto	part0_88		;???

;???????????
part0_86	movfw	part0_ongen_nF		;1/256??
		subwf	part0_ongen_ofF,F	;????
		btfss	STATUS,C		;???????
		decfsz	part0_ongen_ofL,F	;??????
		incf	part0_ongen_ofL,F	;??????
		decf	part0_ongen_ofL,F	;????-1??
		movfw	part0_ongen_nL		;???
		subwf	part0_ongen_ofL,F	;????
		btfss	STATUS,C		;???????
		decf	part0_ongen_ofH,F	;????-1??
		movfw	part0_ongen_nH		;???
		subwf	part0_ongen_ofH,F	;????
part0_88

#if PITCH_N>0
;??????????????????
		movf	part0_pitch,F		;????????????????
		btfsc	STATUS,Z		;?0????
		goto	part0_999		;???????????

;??????????????????????
		decfsz	part0_pitch_pss,F	;?????????????????????????????????????
		goto	part0_999		;???????????
		movfw	part0_pitch		;???????????????????????????
		movwf	part0_pitch_pss		;??????
		decfsz	part0_pitch_ps,F	;???????????????????????????????????????
		goto	part0_999		;???????????
		moviw	HDR_PART0_PITCH_PS[FSR1];????????????????????????????????
		movwf	part0_pitch_ps		;??????

;?????????????
		btfsc	part0_pitch_of,0	;??7???????????
		goto	part0_94		;???
		lsrf	part0_pitch_of,W	;??????????????????????????????
		banksel	EEADRL			;BANK??
		movwf	EEADRL
		moviw	HDR_PART0_PITCH_H[FSR1]
		movwf	EEADRH
		moviw	HDR_PART0_PITCH_L[FSR1]	;???????????????????????
		addwf	EEADRL,F
		btfsc	STATUS,C
		incf	EEADRH,F
		incf	EEADRL,F		;???????????????
		btfsc	STATUS,Z
		incf	EEADRH,F
		bcf	EECON1,EECFGS		;Config??????
		bsf	EECON1,EEPGD		;Program???????
		bsf	EECON1,RD		;?????
		nop
		nop
		rlf	EEDATL,W		;???b7?C????
		rlf	EEDATH,W		;??+C?W????
		banksel	ORGEL_BANK		;???????????????????
		andlw	0x7f			;????????????????7?????
		movwf	part0_pitch_h		;???????
		banksel	EEDATL			;BANK??
		movfw	EEDATL			;??????????????
		andlw	0x7f			;???7?????????
		banksel	ORGEL_BANK		;???????????????????
		goto	part0_96
part0_94	movfw	part0_pitch_h		;?????????7???????

;????????????
part0_96	addlw	192
		btfsc	STATUS,C
		goto	part0_98
		addlw	-192
		addwf	part0_ongen_tobiF,F	;?????????????????????
		btfsc	STATUS,C
		incf	part0_ongen_tobiL,F
		goto	part0_99
part0_98	addlw	-64
		addwf	part0_ongen_tobiF,F	;?????????????????????
		btfss	STATUS,C
		decf	part0_ongen_tobiL,F

;????????????????????
part0_99	incf	part0_pitch_of,F	;?????????????????????????
		movfw	part0_pitch_of		;???
		xorwf	part0_pitch_n,W		;?????
		btfsc	STATUS,Z		;?????
		decf	part0_pitch_of,F	;?????
#endif
part0_999


#if PART_N>1
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;????1????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
		movlw	-2
		addwf	part_su,W
		btfsc	STATUS,C	
		btfss	song_sts,STS_PART1_BIT	;?????????
		goto	part1_999		;???????????

;?????????????????????
		btfss	song_sts,ONKA_FULL_BIT	;??????????????????
		goto	part1_7			;?????????????
		decfsz	part1_onka_zan,F	;????????-1???????
		goto	part1_7			;??????????????

;???????
part1_1		call	part1_get_onpu		;???????????
		movwf	part1_onpu		;???????????
		
;??????????
		swapf	part1_onpu,F		;????????
		rrf	part1_onpu,W		;????????
		swapf	part1_onpu,F		;????
		andlw	0x07			;???????
		btfsc	STATUS,Z		;?0????
		goto	part1_5			;???????????
		movwf	FSR0L			;????????????
		moviw	HDR_PART1_ONKA_H[FSR1]	;???????
		movwf	FSR0H			;?????
		moviw	HDR_PART1_ONKA_L[FSR1]
		addwf	FSR0L,F
		btfsc	STATUS,C
		incf	FSR0H,F
		moviw	-1[FSR0]		;???????
		movwf	part1_onka_zan		;?????

;??/????????
		movfw	part1_onpu		;???????
		andlw	0x1f			;????????
		btfsc	STATUS,Z		;?0????
		goto	part1_4			;????????
		bsf	part1_sts,PART_ON_BIT	;?????????

;????????????????????????
		addlw	-1			;??????-1??????????????????
		banksel	EEADRL			;BANK??
		movwf	EEADRL
		moviw	HDR_PART1_ONKOU_H[FSR1]	;??????????????????
		movwf	EEADRH
		moviw	HDR_PART1_ONKOU_L[FSR1]
		addwf	EEADRL,F		;???????????????????
		btfsc	STATUS,C
		incf	EEADRH,F
		bcf	EECON1,EECFGS		;Config??????
		bsf	EECON1,EEPGD		;Program???????
		bsf	EECON1,RD		;?????
		nop
		nop
		movfw	EEDATL			;?????????????????
		banksel	ORGEL_BANK		;???????????????????
		movwf	part1_ongen_tobiF
		banksel	EEDATH			;BANK??
		movfw	EEDATH
		banksel	ORGEL_BANK		;???????????????????
		movwf	part1_ongen_tobiL

;???????????
part1_3		btfsc	part1_sts,PART_TIE_BIT	;????????????
		goto	part1_71		;???
		clrf	part1_enve_ps		;???????????
		bsf	part1_enve_ps,0		;??????
		clrf	part1_enve_pss
		bsf	part1_enve_pss,0
		clrf	part1_enve_of
#if PITCH_N>1
		clrf	part1_pitch_ps		;????????????
		bsf	part1_pitch_ps,0	;??????
		clrf	part1_pitch_pss
		bsf	part1_pitch_pss,0
		clrf	part1_pitch_of
#endif
		goto	part1_71		;?????????????

;?????
part1_4		bcf	part1_sts,PART_ON_BIT	;???????
		clrf	part1_velo_enve		;?????-??????????????0???
		goto	part1_999		;??????????

;????????
part1_5		movfw	part1_onpu		;???????
		brw				;?????
		goto	part1_51		;?????
		goto	part1_52		;????????
		goto	part1_53		;?????1???????
		goto	part1_54		;?????1?????
		goto	part1_56		;?????2???????
		goto	part1_57		;?????2?????
		goto	part1_59		;???????????
		goto	part1_6			;????????????????
		goto	part1_61		;????????
		goto	part1_62		;?????????
		goto	part1_63		;???????????
		goto	part1_64		;???????????

;?????????????????
		call	part1_get_onpu		;???????????
#if PITCH_N>1
		movwf	part1_pitch		;????????????????????
#endif
		goto	part1_1			;???????

;?????
part1_51	bcf	song_sts,STS_PART1_BIT	;???????
		goto	part1_999		;??????????

;????????
part1_52	call	part1_get_onpu		;???????????
		movwf	part1_step		;????????????
		goto	part1_1			;???????

;?????1???????
part1_53	movlw	0xf0			;??????????
		andwf	part1_repeat,F		;????????
		call	part1_get_onpu		;???????????
		andlw	0x0f			;????????
		iorwf	part1_repeat,F		;???????????????
		goto	part1_1			;???????

;?????1?????
part1_54	movlw	-1			;?????
		addwf	part1_repeat,F		;?-1??
		movfw	part1_repeat		;?????
		andlw	0x0f			;?0?
		btfsc	STATUS,Z		;?????
		goto	part1_55		;???
		call	part1_get_onpu		;???????????
		movwf	part1_step		;????????????
		goto	part1_1			;???????
part1_55	incf	part1_step,F		;?????????????
		goto	part1_1			;???????

;?????2???????
part1_56	swapf	part1_repeat,F		;?????????????????????
		movlw	0xf0			;??????????
		andwf	part1_repeat,F		;????????
		call	part1_get_onpu		;???????????
		andlw	0x0f			;????????
		iorwf	part1_repeat,F		;???????????????
		swapf	part1_repeat,F		;???????????????????
		goto	part1_1			;???????

;?????2?????
part1_57	swapf	part1_repeat,F		;?????????????????????
		movlw	-1			;?????
		addwf	part1_repeat,F		;?-1??
		movfw	part1_repeat		;?????
		andlw	0x0f			;?0?
		btfsc	STATUS,Z		;?????
		goto	part1_58		;???
		call	part1_get_onpu		;???????????
		movwf	part1_step		;????????????
		swapf	part1_repeat,F		;???????????????????
		goto	part1_1			;???????
part1_58	incf	part1_step,F		;?????????????
		swapf	part1_repeat,F		;???????????????????
		goto	part1_1			;???????

;???????????
part1_59	call	part1_get_onpu		;???????????
		movwf	part1_velo		;??????????????
		goto	part1_1			;???????

;????????????????
part1_6		call	part1_get_onpu		;???????????
		movwf	part1_enve		;???????????????????
		goto	part1_1			;???????

;????????
part1_61	call	part1_get_onpu		;??(?????)?????
		movwf	part1_onka_zan
		call	part1_get_onpu		;?????????????????
		movwf	part1_ongen_tobiF
		call	part1_get_onpu
		movwf	part1_ongen_tobiL
		bsf	part1_sts,PART_ON_BIT	;???????????
		iorwf	part1_ongen_tobiF,W	;?????????????
		btfsc	STATUS,Z		;?0????
		bcf	part1_sts,PART_ON_BIT	;????????
		goto	part1_3			;????????

;?????????
part1_62	call	part1_get_onpu		;????(????????????)?????
		movwf	onka_psn		;???????????????
		goto	part1_1			;???????

;???????????
part1_63	bsf	part1_sts,PART_TIE_BIT	;???????????
		goto	part1_1

;???????????
part1_64	bcf	part1_sts,PART_TIE_BIT	;???????????
		goto	part1_1

;?????????????????
part1_7		btfss	part1_sts,PART_ON_BIT	;??????
		goto	part1_999		;???????????
part1_71	movf	part1_enve,F		;???????????????
		btfss	STATUS,Z		;?0?????
		goto	part1_72		;????????????????
		movfw	part1_velo		;??????????
		movwf	part1_velo_enve		;??????-????????????????
		goto	part1_8

;?????????????????????
part1_72	decfsz	part1_enve_pss,F	;????????????????????????????????????
		goto	part1_8			;???????????????
		movfw	part1_enve		;?????????????????????????????
		movwf	part1_enve_pss		;??????
		decfsz	part1_enve_ps,F		;??????????????????????????????????????
		goto	part1_8			;???????????????
		moviw	HDR_PART1_ENVE_PS[FSR1]	;???????????????????????????????
		movwf	part1_enve_ps		;??????

;????????????
		btfsc	part1_enve_of,0		;??7???????????
		goto	part1_74		;???
		lsrf	part1_enve_of,W		;??????????????????????????????
		banksel	EEADRL			;BANK??
		movwf	EEADRL
		moviw	HDR_PART1_ENVE_H[FSR1]
		movwf	EEADRH
		moviw	HDR_PART1_ENVE_L[FSR1]	;???????????????????????
		addwf	EEADRL,F
		btfsc	STATUS,C
		incf	EEADRH,F
		incf	EEADRL,F		;???????????????
		btfsc	STATUS,Z
		incf	EEADRH,F
		bcf	EECON1,EECFGS		;Config??????
		bsf	EECON1,EEPGD		;Program???????
		bsf	EECON1,RD		;?????
		nop
		nop
		rlf	EEDATL,W		;???b7?C????
		rlf	EEDATH,W		;??+C?W????
		banksel	ORGEL_BANK		;???????????????????
		andlw	0x7f			;????????????????7?????
		movwf	part1_enve_h		;???????
		banksel	EEDATL			;BANK??
		movfw	EEDATL			;??????????????
		andlw	0x7f			;???7?????????
		banksel	ORGEL_BANK		;???????????????????
		goto	part1_76
part1_74	movfw	part1_enve_h		;?????????7???????

;??????????????????????
part1_76	movwf	mul_b			;?????????(7????)?
		movfw	part1_velo
		movwf	mul_a			;??????????(8????)?
		call	mul7_exe		;?????
		movfw	mul_cH			;??15???????8?????
		movwf	part1_velo_enve		;???????????????????????

;??????????????
		incf	part1_enve_of,F		;?????????????????????????
		movfw	part1_enve_of		;???
		xorwf	part1_enve_n,W		;?????
		btfsc	STATUS,Z		;?????
		decf	part1_enve_of,F		;?????

;???????????
part1_8		lsrf	part1_ongen_ofH,W	;????????????????
		banksel	EEADRH			;BANK??
		movwf	EEADRH
		banksel	ORGEL_BANK		;???????????????????
		rrf	part1_ongen_ofL,W
		banksel	EEADRL			;BANK??
		addlw	WAVE_DATA
		movwf	EEADRL			;??????????????????
		btfsc	STATUS,C
		incf	EEADRH,F
		moviw	HDR_PART1_ONGEN_L[FSR1]
		addwf	EEADRL,F		;???????????????????
		btfsc	STATUS,C
		incf	EEADRH,F
		moviw	HDR_PART1_ONGEN_H[FSR1]
		addwf	EEADRH,F
		bcf	EECON1,EECFGS		;Config??????
		bsf	EECON1,EEPGD		;Program???????
		bsf	EECON1,RD		;?????
		nop
		nop
		banksel	ORGEL_BANK		;???????????????????
		btfsc	part1_ongen_ofL,0	;????????????
		goto	part1_82		;???
		banksel	EEDATL			;BANK??
		movfw	EEDATL			;??7?????????
		goto	part1_84
part1_82
		banksel	EEDATL			;BANK??
		rlf	EEDATL,W		;??7?????????
		rlf	EEDATH,W
part1_84	andlw	0x7f

;??????????????????
		banksel	ORGEL_BANK		;???????????????????
		movwf	mul_b			;???????(7????)?
		movfw	part1_velo_enve		;?????????????
		movwf	mul_a			;????????(8????)?
		call	mul7_exe		;?????
		movfw	mul_cH			;??15???????8?????
		addwf	song_out,W		;???????????
		btfsc	STATUS,C		;??????????
		movlw	255			;?????
		movwf	song_out		;?????

;???????????
		movfw	part1_ongen_tobiF	;???????(1/256)??????????
		addwf	part1_ongen_ofF,F
		btfsc	STATUS,C		;??????????
		incfsz	part1_ongen_ofL,F	;???+1??
		decf	part1_ongen_ofH,F	;??????????
		incf	part1_ongen_ofH,F	;????+1??
		movfw	part1_ongen_tobiL	;???
		addwf	part1_ongen_ofL,F	;????
		btfsc	STATUS,C		;???????
		incf	part1_ongen_ofH,F	;????+1??

;????????????????
		movfw	part1_ongen_nH		;???????
		subwf	part1_ongen_ofH,W	;????
		btfss	STATUS,C		;?????????
		goto	part1_88		;???
		btfss	STATUS,Z		;?????????
		goto	part1_86		;???
		movfw	part1_ongen_nL		;??????
		subwf	part1_ongen_ofL,W	;????
		btfss	STATUS,C		;?????????
		goto	part1_88		;???
		movfw	part1_ongen_nF		;??????
		subwf	part1_ongen_ofF,W	;?1/256??
		btfss	STATUS,C		;?????????
		goto	part1_88		;???

;???????????
part1_86	movfw	part1_ongen_nF		;1/256??
		subwf	part1_ongen_ofF,F	;????
		btfss	STATUS,C		;???????
		decfsz	part1_ongen_ofL,F	;??????
		incf	part1_ongen_ofL,F	;??????
		decf	part1_ongen_ofL,F	;????-1??
		movfw	part1_ongen_nL		;???
		subwf	part1_ongen_ofL,F	;????
		btfss	STATUS,C		;???????
		decf	part1_ongen_ofH,F	;????-1??
		movfw	part1_ongen_nH		;???
		subwf	part1_ongen_ofH,F	;????
part1_88

#if PITCH_N>1
;??????????????????
		movf	part1_pitch,F		;????????????????
		btfsc	STATUS,Z		;?0????
		goto	part1_999		;???????????

;??????????????????????
		decfsz	part1_pitch_pss,F	;?????????????????????????????????????
		goto	part1_999		;???????????
		movfw	part1_pitch		;???????????????????????????
		movwf	part1_pitch_pss		;??????
		decfsz	part1_pitch_ps,F	;???????????????????????????????????????
		goto	part1_999		;???????????
		moviw	HDR_PART1_PITCH_PS[FSR1];????????????????????????????????
		movwf	part1_pitch_ps		;??????

;?????????????
		btfsc	part1_pitch_of,0	;??7???????????
		goto	part1_94		;???
		lsrf	part1_pitch_of,W	;??????????????????????????????
		banksel	EEADRL			;BANK??
		movwf	EEADRL
		moviw	HDR_PART1_PITCH_H[FSR1]
		movwf	EEADRH
		moviw	HDR_PART1_PITCH_L[FSR1]	;???????????????????????
		addwf	EEADRL,F
		btfsc	STATUS,C
		incf	EEADRH,F
		incf	EEADRL,F		;???????????????
		btfsc	STATUS,Z
		incf	EEADRH,F
		bcf	EECON1,EECFGS		;Config??????
		bsf	EECON1,EEPGD		;Program???????
		bsf	EECON1,RD		;?????
		nop
		nop
		rlf	EEDATL,W		;???b7?C????
		rlf	EEDATH,W		;??+C?W????
		banksel	ORGEL_BANK		;???????????????????
		andlw	0x7f			;????????????????7?????
		movwf	part1_pitch_h		;???????
		banksel	EEDATL			;BANK??
		movfw	EEDATL			;??????????????
		andlw	0x7f			;???7?????????
		banksel	ORGEL_BANK		;???????????????????
		goto	part1_96
part1_94	movfw	part1_pitch_h		;?????????7???????

;????????????
part1_96	addlw	192
		btfsc	STATUS,C
		goto	part1_98
		addlw	-192
		addwf	part1_ongen_tobiF,F	;?????????????????????
		btfsc	STATUS,C
		incf	part1_ongen_tobiL,F
		goto	part1_99
part1_98	addlw	-64
		addwf	part1_ongen_tobiF,F	;?????????????????????
		btfss	STATUS,C
		decf	part1_ongen_tobiL,F

;????????????????????
part1_99	incf	part1_pitch_of,F	;?????????????????????????
		movfw	part1_pitch_of		;???
		xorwf	part1_pitch_n,W		;?????
		btfsc	STATUS,Z		;?????
		decf	part1_pitch_of,F	;?????
#endif
part1_999
#endif


#if PART_N>2
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;????2????
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
		movlw	-3
		addwf	part_su,W
		btfsc	STATUS,C	
		btfss	song_sts,STS_PART2_BIT	;?????????
		goto	part2_999		;???????????

;?????????????????????
		btfss	song_sts,ONKA_FULL_BIT	;??????????????????
		goto	part2_7			;?????????????
		decfsz	part2_onka_zan,F	;????????-1???????
		goto	part2_7			;??????????????

;???????
part2_1		call	part2_get_onpu		;???????????
		movwf	part2_onpu		;???????????
		
;??????????
		swapf	part2_onpu,F		;????????
		rrf	part2_onpu,W		;????????
		swapf	part2_onpu,F		;????
		andlw	0x07			;???????
		btfsc	STATUS,Z		;?0????
		goto	part2_5			;???????????
		movwf	FSR0L			;????????????
		moviw	HDR_PART2_ONKA_H[FSR1]	;???????
		movwf	FSR0H			;?????
		moviw	HDR_PART2_ONKA_L[FSR1]
		addwf	FSR0L,F
		btfsc	STATUS,C
		incf	FSR0H,F
		moviw	-1[FSR0]		;???????
		movwf	part2_onka_zan		;?????

;??/????????
		movfw	part2_onpu		;???????
		andlw	0x1f			;????????
		btfsc	STATUS,Z		;?0????
		goto	part2_4			;????????
		bsf	part2_sts,PART_ON_BIT	;?????????

;????????????????????????
		addlw	-1			;??????-1??????????????????
		banksel	EEADRL			;BANK??
		movwf	EEADRL
		moviw	HDR_PART2_ONKOU_H[FSR1]	;??????????????????
		movwf	EEADRH
		moviw	HDR_PART2_ONKOU_L[FSR1]
		addwf	EEADRL,F		;???????????????????
		btfsc	STATUS,C
		incf	EEADRH,F
		bcf	EECON1,EECFGS		;Config??????
		bsf	EECON1,EEPGD		;Program???????
		bsf	EECON1,RD		;?????
		nop
		nop
		movfw	EEDATL			;?????????????????
		banksel	ORGEL_BANK		;???????????????????
		movwf	part2_ongen_tobiF
		banksel	EEDATH			;BANK??
		movfw	EEDATH
		banksel	ORGEL_BANK		;???????????????????
		movwf	part2_ongen_tobiL

;???????????
part2_3		btfsc	part2_sts,PART_TIE_BIT	;????????????
		goto	part2_71		;???
		clrf	part2_enve_ps		;???????????
		bsf	part2_enve_ps,0		;??????
		clrf	part2_enve_pss
		bsf	part2_enve_pss,0
		clrf	part2_enve_of
#if PITCH_N>2
		clrf	part2_pitch_ps		;????????????
		bsf	part2_pitch_ps,0	;??????
		clrf	part2_pitch_pss
		bsf	part2_pitch_pss,0
		clrf	part2_pitch_of
#endif
		goto	part2_71		;?????????????

;?????
part2_4		bcf	part2_sts,PART_ON_BIT	;???????
		clrf	part2_velo_enve		;?????-??????????????0???
		goto	part2_999		;??????????

;????????
part2_5		movfw	part2_onpu		;???????
		brw				;?????
		goto	part2_51		;?????
		goto	part2_52		;????????
		goto	part2_53		;?????1???????
		goto	part2_54		;?????1?????
		goto	part2_56		;?????2???????
		goto	part2_57		;?????2?????
		goto	part2_59		;???????????
		goto	part2_6			;????????????????
		goto	part2_61		;????????
		goto	part2_62		;?????????
		goto	part2_63		;???????????
		goto	part2_64		;???????????

;?????????????????
		call	part2_get_onpu		;???????????
#if PITCH_N>2
		movwf	part2_pitch		;????????????????????
#endif
		goto	part2_1			;???????

;?????
part2_51	bcf	song_sts,STS_PART2_BIT	;???????
		goto	part2_999		;??????????

;????????
part2_52	call	part2_get_onpu		;???????????
		movwf	part2_step		;????????????
		goto	part2_1			;???????

;?????1???????
part2_53	movlw	0xf0			;??????????
		andwf	part2_repeat,F		;????????
		call	part2_get_onpu		;???????????
		andlw	0x0f			;????????
		iorwf	part2_repeat,F		;???????????????
		goto	part2_1			;???????

;?????1?????
part2_54	movlw	-1			;?????
		addwf	part2_repeat,F		;?-1??
		movfw	part2_repeat		;?????
		andlw	0x0f			;?0?
		btfsc	STATUS,Z		;?????
		goto	part2_55		;???
		call	part2_get_onpu		;???????????
		movwf	part2_step		;????????????
		goto	part2_1			;???????
part2_55	incf	part2_step,F		;?????????????
		goto	part2_1			;???????

;?????2???????
part2_56	swapf	part2_repeat,F		;?????????????????????
		movlw	0xf0			;??????????
		andwf	part2_repeat,F		;????????
		call	part2_get_onpu		;???????????
		andlw	0x0f			;????????
		iorwf	part2_repeat,F		;???????????????
		swapf	part2_repeat,F		;???????????????????
		goto	part2_1			;???????

;?????2?????
part2_57	swapf	part2_repeat,F		;?????????????????????
		movlw	-1			;?????
		addwf	part2_repeat,F		;?-1??
		movfw	part2_repeat		;?????
		andlw	0x0f			;?0?
		btfsc	STATUS,Z		;?????
		goto	part2_58		;???
		call	part2_get_onpu		;???????????
		movwf	part2_step		;????????????
		swapf	part2_repeat,F		;???????????????????
		goto	part2_1			;???????
part2_58	incf	part2_step,F		;?????????????
		swapf	part2_repeat,F		;???????????????????
		goto	part2_1			;???????

;???????????
part2_59	call	part2_get_onpu		;???????????
		movwf	part2_velo		;??????????????
		goto	part2_1			;???????

;????????????????
part2_6		call	part2_get_onpu		;???????????
		movwf	part2_enve		;???????????????????
		goto	part2_1			;???????

;????????
part2_61	call	part2_get_onpu		;??(?????)?????
		movwf	part2_onka_zan
		call	part2_get_onpu		;?????????????????
		movwf	part2_ongen_tobiF
		call	part2_get_onpu
		movwf	part2_ongen_tobiL
		bsf	part2_sts,PART_ON_BIT	;???????????
		iorwf	part2_ongen_tobiF,W	;?????????????
		btfsc	STATUS,Z		;?0????
		bcf	part2_sts,PART_ON_BIT	;????????
		goto	part2_3			;????????

;?????????
part2_62	call	part2_get_onpu		;????(????????????)?????
		movwf	onka_psn		;???????????????
		goto	part2_1			;???????

;???????????
part2_63	bsf	part2_sts,PART_TIE_BIT	;???????????
		goto	part2_1

;???????????
part2_64	bcf	part2_sts,PART_TIE_BIT	;???????????
		goto	part2_1

;?????????????????
part2_7		btfss	part2_sts,PART_ON_BIT	;??????
		goto	part2_999		;???????????
part2_71	movf	part2_enve,F		;???????????????
		btfss	STATUS,Z		;?0?????
		goto	part2_72		;????????????????
		movfw	part2_velo		;??????????
		movwf	part2_velo_enve		;??????-????????????????
		goto	part2_8

;?????????????????????
part2_72	decfsz	part2_enve_pss,F	;????????????????????????????????????
		goto	part2_8			;???????????????
		movfw	part2_enve		;?????????????????????????????
		movwf	part2_enve_pss		;??????
		decfsz	part2_enve_ps,F		;??????????????????????????????????????
		goto	part2_8			;???????????????
		moviw	HDR_PART2_ENVE_PS[FSR1]	;???????????????????????????????
		movwf	part2_enve_ps		;??????

;????????????
		btfsc	part2_enve_of,0		;??7???????????
		goto	part2_74		;???
		lsrf	part2_enve_of,W		;??????????????????????????????
		banksel	EEADRL			;BANK??
		movwf	EEADRL
		moviw	HDR_PART2_ENVE_H[FSR1]
		movwf	EEADRH
		moviw	HDR_PART2_ENVE_L[FSR1]	;???????????????????????
		addwf	EEADRL,F
		btfsc	STATUS,C
		incf	EEADRH,F
		incf	EEADRL,F		;???????????????
		btfsc	STATUS,Z
		incf	EEADRH,F
		bcf	EECON1,EECFGS		;Config??????
		bsf	EECON1,EEPGD		;Program???????
		bsf	EECON1,RD		;?????
		nop
		nop
		rlf	EEDATL,W		;???b7?C????
		rlf	EEDATH,W		;??+C?W????
		banksel	ORGEL_BANK		;???????????????????
		andlw	0x7f			;????????????????7?????
		movwf	part2_enve_h		;???????
		banksel	EEDATL			;BANK??
		movfw	EEDATL			;??????????????
		andlw	0x7f			;???7?????????
		banksel	ORGEL_BANK		;???????????????????
		goto	part2_76
part2_74	movfw	part2_enve_h		;?????????7???????

;??????????????????????
part2_76	movwf	mul_b			;?????????(7????)?
		movfw	part2_velo
		movwf	mul_a			;??????????(8????)?
		call	mul7_exe		;?????
		movfw	mul_cH			;??15???????8?????
		movwf	part2_velo_enve		;???????????????????????

;??????????????
		incf	part2_enve_of,F		;?????????????????????????
		movfw	part2_enve_of		;???
		xorwf	part2_enve_n,W		;?????
		btfsc	STATUS,Z		;?????
		decf	part2_enve_of,F		;?????

;???????????
part2_8		lsrf	part2_ongen_ofH,W	;????????????????
		banksel	EEADRH			;BANK??
		movwf	EEADRH
		banksel	ORGEL_BANK		;???????????????????
		rrf	part2_ongen_ofL,W
		banksel	EEADRL			;BANK??
		addlw	WAVE_DATA
		movwf	EEADRL			;??????????????????
		btfsc	STATUS,C
		incf	EEADRH,F
		moviw	HDR_PART2_ONGEN_L[FSR1]
		addwf	EEADRL,F		;???????????????????
		btfsc	STATUS,C
		incf	EEADRH,F
		moviw	HDR_PART2_ONGEN_H[FSR1]
		addwf	EEADRH,F
		bcf	EECON1,EECFGS		;Config??????
		bsf	EECON1,EEPGD		;Program???????
		bsf	EECON1,RD		;?????
		nop
		nop
		banksel	ORGEL_BANK		;???????????????????
		btfsc	part2_ongen_ofL,0	;????????????
		goto	part2_82		;???
		banksel	EEDATL			;BANK??
		movfw	EEDATL			;??7?????????
		goto	part2_84
part2_82
		banksel	EEDATL			;BANK??
		rlf	EEDATL,W		;??7?????????
		rlf	EEDATH,W
part2_84	andlw	0x7f
		banksel	ORGEL_BANK		;???????????????????

;??????????????????
		banksel	ORGEL_BANK		;???????????????????
		movwf	mul_b			;???????(7????)?
		movfw	part2_velo_enve		;?????????????
		movwf	mul_a			;????????(8????)?
		call	mul7_exe		;?????
		movfw	mul_cH			;??15???????8?????
		addwf	song_out,W		;???????????
		btfsc	STATUS,C		;??????????
		movlw	255			;?????
		movwf	song_out		;?????

;???????????
		movfw	part2_ongen_tobiF	;???????(1/256)??????????
		addwf	part2_ongen_ofF,F
		btfsc	STATUS,C		;??????????
		incfsz	part2_ongen_ofL,F	;???+1??
		decf	part2_ongen_ofH,F	;??????????
		incf	part2_ongen_ofH,F	;????+1??

		movfw	part2_ongen_tobiL	;???
		addwf	part2_ongen_ofL,F	;????
		btfsc	STATUS,C		;???????
		incf	part2_ongen_ofH,F	;????+1??

;????????????????
		movfw	part2_ongen_nH		;???????
		subwf	part2_ongen_ofH,W	;????
		btfss	STATUS,C		;?????????
		goto	part2_88		;???
		btfss	STATUS,Z		;?????????
		goto	part2_86		;???
		movfw	part2_ongen_nL		;??????
		subwf	part2_ongen_ofL,W	;????
		btfss	STATUS,C		;?????????
		goto	part2_88		;???
		movfw	part2_ongen_nF		;??????
		subwf	part2_ongen_ofF,W	;?1/256??
		btfss	STATUS,C		;?????????
		goto	part2_88		;???

;???????????
part2_86	movfw	part2_ongen_nF		;1/256??
		subwf	part2_ongen_ofF,F	;????
		btfss	STATUS,C		;???????
		decfsz	part2_ongen_ofL,F	;??????
		incf	part2_ongen_ofL,F	;??????
		decf	part2_ongen_ofL,F	;????-1??
		movfw	part2_ongen_nL		;???
		subwf	part2_ongen_ofL,F	;????
		btfss	STATUS,C		;???????
		decf	part2_ongen_ofH,F	;????-1??
		movfw	part2_ongen_nH		;???
		subwf	part2_ongen_ofH,F	;????
part2_88

#if PITCH_N>2
;??????????????????
		movf	part2_pitch,F		;????????????????
		btfsc	STATUS,Z		;?0????
		goto	part2_999		;???????????

;??????????????????????
		decfsz	part2_pitch_pss,F	;?????????????????????????????????????
		goto	part2_999		;???????????
		movfw	part2_pitch		;???????????????????????????
		movwf	part2_pitch_pss		;??????
		decfsz	part2_pitch_ps,F	;???????????????????????????????????????
		goto	part2_999		;???????????
		moviw	HDR_PART2_PITCH_PS[FSR1];????????????????????????????????
		movwf	part2_pitch_ps		;??????

;?????????????
		btfsc	part2_pitch_of,0	;??7???????????
		goto	part2_94		;???
		lsrf	part2_pitch_of,W	;??????????????????????????????
		banksel	EEADRL			;BANK??
		movwf	EEADRL
		moviw	HDR_PART2_PITCH_H[FSR1]
		movwf	EEADRH
		moviw	HDR_PART2_PITCH_L[FSR1]	;???????????????????????
		addwf	EEADRL,F
		btfsc	STATUS,C
		incf	EEADRH,F
		incf	EEADRL,F		;???????????????
		btfsc	STATUS,Z
		incf	EEADRH,F
		bcf	EECON1,EECFGS		;Config??????
		bsf	EECON1,EEPGD		;Program???????
		bsf	EECON1,RD		;?????
		nop
		nop
		rlf	EEDATL,W		;???b7?C????
		rlf	EEDATH,W		;??+C?W????
		banksel	ORGEL_BANK		;???????????????????
		andlw	0x7f			;????????????????7?????
		movwf	part2_pitch_h		;???????
		banksel	EEDATL			;BANK??
		movfw	EEDATL			;??????????????
		andlw	0x7f			;???7?????????
		banksel	ORGEL_BANK		;???????????????????
		goto	part2_96
part2_94	movfw	part2_pitch_h		;?????????7???????

;????????????
part2_96	addlw	192
		btfsc	STATUS,C
		goto	part2_98
		addlw	-192
		addwf	part2_ongen_tobiF,F	;?????????????????????
		btfsc	STATUS,C
		incf	part2_ongen_tobiL,F
		goto	part2_99
part2_98	addlw	-64
		addwf	part2_ongen_tobiF,F	;?????????????????????
		btfss	STATUS,C
		decf	part2_ongen_tobiL,F

;????????????????????
part2_99	incf	part2_pitch_of,F	;?????????????????????????
		movfw	part2_pitch_of		;???
		xorwf	part2_pitch_n,W		;?????
		btfsc	STATUS,Z		;?????
		decf	part2_pitch_of,F	;?????
#endif
part2_999
#endif
		return
#endif


#if VOICE_N>0
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;??0????(API??)
;input
;?W(b7):???????????(0=???1=?????????????)
;?W(b5-0):????(0=?????1?63=???????????)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;???????
VOICE0_SEL	movwf	mul_wk			;???????????????
		xorwf	voice0_no,W		;??????
		andlw	~VO_STS_MSK		;??????
		btfsc	STATUS,Z		;???????
		return				;???????
		xorwf	voice0_no,W		;?????
		andlw	~VO_STS_MSK		;?????
		btfss	STATUS,Z		;?????
		goto	voice0_sel5		;?0????
		clrf	voice0_no		;??????????????????
		return

;???????????
voice0_sel5	addlw	-((voiceN_tbl_end-voiceN_tbl)/HDR_VOn_size+1)
						;?????????????
		btfsc	STATUS,C		;??????
		return				;???????
		addlw	(voiceN_tbl_end-voiceN_tbl)/HDR_VOn_size+1
						;?????????
		movwf	voice0_no		;???????????

;????????????????
		movfw	BSR			;BSR?
		movwf	api_bsr			;?????
		banksel	VOICE_BANK		;?????????BANK??
		movlw	high(voiceN_tbl)	;???????????????
		movwf	FSR0H			;?????????
		decf	voice0_no,W		;????-1???????
		movwf	FSR0L			;??????*5?
		lslf	FSR0L,F			;?????????????????
		lslf	FSR0L,F
		addwf	FSR0L,F
		movlw	0			;?????
		addwfc	FSR0H,F			;?????
		movlw	low(voiceN_tbl)		;??????????????????
		addwf	FSR0L,F			;?????????????
		movlw	0			;?????
		addwfc	FSR0H,F			;?????

;?????????
		moviw	HDR_VOn_PT_H[FSR0]	;?????????????????
		movwf	voice0_ptH		;?????
		moviw	HDR_VOn_PT_L[FSR0]
		movwf	voice0_ptL
		lslf	voice0_ptL,F		;?????????????
		rlf	voice0_ptH,F
		moviw	HDR_VOn_LN_H[FSR0]	;?????????????
		movwf	voice0_zanH		;?????
		moviw	HDR_VOn_LN_L[FSR0]
		movwf	voice0_zanL
		moviw	HDR_VOn_PSN[FSR0]	;??????????????
		movwf	voice0_psn		;?????
		movwf	voice0_ps		;???????????????
		incf	voice0_zanH,F		;decf???????
		incf	voice0_zanL,F		; ??+1????

;????????
		bsf	voice0_no,VO_STS0_BIT	;????????????
		btfss	mul_wk,7		;????????????????
		bsf	voice0_no,VO_STS1_BIT	;????????????
		movfw	api_bsr			;BSR?
		movwf	BSR			;?????
		return
#endif


#if VOICE_N>0
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;??0????
;OUTPUT W:????(0=???????1=??????)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
playback0
		banksel	VOICE_BANK		;?????????BANK??
		btfsc	voice0_ptL,0		;??(??????)???????
		goto	playback0_3		;???

;?????????????
		decfsz	voice0_zanL,F		;???????????
		goto	playback0_1		;????????
		decfsz	voice0_zanH,F		;???????????
		goto	playback0_1		;????????
		retlw	1			;???????????

;?????????
playback0_1	lsrf	voice0_ptH,W		;?????????????????????
		banksel	EEADRH			;BANK??
		movwf	EEADRH			;?EEP????????????
		banksel	VOICE_BANK		;?????????BANK??
		rrf	voice0_ptL,W		;?????????????????????
		banksel	EEADRL			;BANK??
		movwf	EEADRL			;?EEP????????????
		bcf	EECON1,EECFGS		;Config??????
		bsf	EECON1,EEPGD		;Program???????
		bsf	EECON1,RD		;?????
		nop
		nop
		lslf	EEDATL,F		;???????
		rlf	EEDATH,W		;???7?????????
		banksel	VOICE_BANK		;?????????BANK??
		movwf	voice0_data		;???????????????

;??(??????)???
		banksel	EEDATL			;BANK??
		movfw	EEDATL			;?????????????????
		banksel	VOICE_BANK		;?????????BANK??
		bsf	voice0_ptL,0		;??????????
		goto	playback0_5

;??(??????)???
playback0_3	lslf	voice0_data,W		;????????????????????

;??????????
		incfsz	voice0_ptL,F		;???????
		decf	voice0_ptH,F		;???
		incf	voice0_ptH,F		;????

;PWM???????????
playback0_5	CALLCNV	voice_cnv

;?????????????
#if VOICE0_VOL==25
		movwf	voice_out		;1/4???????????
		lsrf	voice_out,F
		lsrf	voice_out,F
#else
#if VOICE0_VOL==50
		movwf	voice_out		;1/2???????????
		lsrf	voice_out,F
#else
#if VOICE0_VOL==75
		movwf	voice_out		;3/4???????????
		lsrf	voice_out,F		;1/2?
		lsrf	voice_out,W		;?1/4?
		addwf	voice_out,F		;???
#else
#if VOICE0_VOL==100
		movwf	voice_out		;1/1??????
#else
		movwf	mul_b			;???(7???????)?
		movlw	PWM_CT*VOICE0_VOL/100	;????????(8????)?
		movwf	mul_a
		call	mul7_exe		;?????
		movfw	mul_cH			;??(15???????)???8?????
		movwf	voice_out		;???????????
#endif
#endif
#endif
#endif
		retlw	0			;???????????
#endif


#if VOICE_N>1
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;??1????(API??)
;input
;?W(b7):???????????(0=???1=?????????????)
;?W(b5-0):????(0=?????1?63=???????????)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;???????
VOICE1_SEL	movwf	mul_wk			;???????????????
		xorwf	voice1_no,W		;??????
		andlw	~VO_STS_MSK		;??????
		btfsc	STATUS,Z		;???????
		return				;???????
		xorwf	voice1_no,W		;?????
		andlw	~VO_STS_MSK		;?????
		btfss	STATUS,Z		;?????
		goto	voice1_sel5		;?0????
		clrf	voice1_no		;??????????????????
		return

;???????????
voice1_sel5	addlw	-((voiceN_tbl_end-voiceN_tbl)/HDR_VOn_size+1)
						;?????????????
		btfsc	STATUS,C		;??????
		return				;???????
		addlw	(voiceN_tbl_end-voiceN_tbl)/HDR_VOn_size+1
						;?????????
		movwf	voice1_no		;???????????

;?????????????
		movfw	BSR			;BSR?
		movwf	api_bsr			;?????
		banksel	VOICE_BANK		;?????????BANK??
		movlw	high(voiceN_tbl)	;???????????????
		movwf	FSR0H			;?????????
		decf	voice1_no,W		;????-1???????
		movwf	FSR0L			;??????*5?
		lslf	FSR0L,F			;?????????????????
		lslf	FSR0L,F
		addwf	FSR0L,F
		movlw	0			;?????
		addwfc	FSR0H,F			;?????
		movlw	low(voiceN_tbl)		;??????????????????
		addwf	FSR0L,F			;?????????????
		movlw	0			;?????
		addwfc	FSR0H,F			;?????

;?????????
		moviw	HDR_VOn_PT_H[FSR0]	;?????????????????
		movwf	voice1_ptH		;?????
		moviw	HDR_VOn_PT_L[FSR0]
		movwf	voice1_ptL
		lslf	voice1_ptL,F		;?????????????
		rlf	voice1_ptH,F
		moviw	HDR_VOn_LN_H[FSR0]	;?????????????
		movwf	voice1_zanH		;?????
		moviw	HDR_VOn_LN_L[FSR0]
		movwf	voice1_zanL
		moviw	HDR_VOn_PSN[FSR0]	;??????????????
		movwf	voice1_psn		;?????
		movwf	voice1_ps		;???????????????
		incf	voice1_zanH,F		;decf???????
		incf	voice1_zanL,F		; ??+1????

;????????
		bsf	voice1_no,VO_STS0_BIT	;????????????
		btfss	mul_wk,7		;????????????????
		bsf	voice1_no,VO_STS1_BIT	;????????????
		movfw	api_bsr			;BSR?
		movwf	BSR			;?????
		return
#endif


#if VOICE_N>1
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;??1????
;OUTPUT W:????(0=???????1=??????)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
playback1
		banksel	VOICE_BANK		;?????????BANK??
		btfsc	voice1_ptL,0		;??(??????)???????
		goto	playback1_3		;???

;?????????????
		decfsz	voice1_zanL,F		;???????????
		goto	playback1_1		;????????
		decfsz	voice1_zanH,F		;???????????
		goto	playback1_1		;????????
		retlw	1			;???????????

;?????????
playback1_1	lsrf	voice1_ptH,W		;?????????????????????
		banksel	EEADRH			;BANK??
		movwf	EEADRH			;?EEP????????????
		banksel	VOICE_BANK		;?????????BANK??
		rrf	voice1_ptL,W		;?????????????????????
		banksel	EEADRL			;BANK??
		movwf	EEADRL			;?EEP????????????
		bcf	EECON1,EECFGS		;Config??????
		bsf	EECON1,EEPGD		;Program???????
		bsf	EECON1,RD		;?????
		nop
		nop
		lslf	EEDATL,F		;???????
		rlf	EEDATH,W		;???7?????????
		banksel	VOICE_BANK		;?????????BANK??
		movwf	voice1_data		;???????????????

;??(??????)???
		banksel	EEDATL			;BANK??
		movfw	EEDATL			;?????????????????
		banksel	VOICE_BANK		;?????????BANK??
		bsf	voice1_ptL,0		;??????????
		goto	playback1_5

;??(??????)???
playback1_3	lslf	voice1_data,W		;????????????????????

;??????????
		incfsz	voice1_ptL,F		;???????
		decf	voice1_ptH,F		;???
		incf	voice1_ptH,F		;????

;PWM???????????
playback1_5	CALLCNV	voice_cnv

;?????????????
#if VOICE1_VOL==25
		movwf	voice_out		;1/4???????????
		lsrf	voice_out,F
		lsrf	voice_out,F
#else
#if VOICE1_VOL==50
		movwf	voice_out		;1/2???????????
		lsrf	voice_out,F
#else
#if VOICE1_VOL==75
		movwf	voice_out		;3/4???????????
		lsrf	voice_out,F		;1/2?
		lsrf	voice_out,W		;?1/4?
		addwf	voice_out,F		;???
#else
#if VOICE1_VOL==100
		movwf	voice_out		;1/1??????
#else
		movwf	mul_b			;???(7???????)?
		movlw	PWM_CT*VOICE1_VOL/100	;????????(8????)?
		movwf	mul_a
		call	mul7_exe		;?????
		movfw	mul_cH			;??(15???????)???8?????
		movwf	voice_out		;???????????
#endif
#endif
#endif
#endif
		retlw	0			;???????????
#endif


#if VOICE_N>2
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;??2????(API??)
;input
;?W(b7):???????????(0=???1=?????????????)
;?W(b5-0):????(0=?????1?63=???????????)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;???????
VOICE2_SEL	movwf	mul_wk			;???????????????
		xorwf	voice2_no,W		;??????
		andlw	~VO_STS_MSK		;??????
		btfsc	STATUS,Z		;???????
		return				;???????
		xorwf	voice2_no,W		;?????
		andlw	~VO_STS_MSK		;?????
		btfss	STATUS,Z		;?????
		goto	voice2_sel5		;?0????
		clrf	voice2_no		;??????????????????
		return

;???????????
voice2_sel5	addlw	-((voiceN_tbl_end-voiceN_tbl)/HDR_VOn_size+1)
						;?????????????
		btfsc	STATUS,C		;??????
		return				;???????
		addlw	(voiceN_tbl_end-voiceN_tbl)/HDR_VOn_size+1
						;?????????
		movwf	voice2_no		;???????????

;?????????????
		movfw	BSR			;BSR?
		movwf	api_bsr			;?????
		banksel	VOICE_BANK		;?????????BANK??
		movlw	high(voiceN_tbl)	;???????????????
		movwf	FSR0H			;?????????
		decf	voice2_no,W		;????-1???????
		movwf	FSR0L			;??????*5?
		lslf	FSR0L,F			;?????????????????
		lslf	FSR0L,F
		addwf	FSR0L,F
		movlw	0			;?????
		addwfc	FSR0H,F			;?????
		movlw	low(voiceN_tbl)		;??????????????????
		addwf	FSR0L,F			;?????????????
		movlw	0			;?????
		addwfc	FSR0H,F			;?????

;?????????
		moviw	HDR_VOn_PT_H[FSR0]	;?????????????????
		movwf	voice2_ptH		;?????
		moviw	HDR_VOn_PT_L[FSR0]
		movwf	voice2_ptL
		lslf	voice2_ptL,F		;?????????????
		rlf	voice2_ptH,F
		moviw	HDR_VOn_LN_H[FSR0]	;?????????????
		movwf	voice2_zanH		;?????
		moviw	HDR_VOn_LN_L[FSR0]
		movwf	voice2_zanL
		moviw	HDR_VOn_PSN[FSR0]	;??????????????
		movwf	voice2_psn		;?????
		movwf	voice2_ps		;???????????????
		incf	voice2_zanH,F		;decf???????
		incf	voice2_zanL,F		; ??+1????

;????????
		bsf	voice2_no,VO_STS0_BIT	;????????????
		btfss	mul_wk,7		;????????????????
		bsf	voice2_no,VO_STS1_BIT	;????????????
		movfw	api_bsr			;BSR?
		movwf	BSR			;?????
		return
#endif


#if VOICE_N>2
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;??2????
;OUTPUT W:????(0=???????1=??????)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
playback2
		banksel	VOICE_BANK		;?????????BANK??
		btfsc	voice2_ptL,0		;??(??????)???????
		goto	playback2_3		;???

;?????????????
		decfsz	voice2_zanL,F		;???????????
		goto	playback2_1		;????????
		decfsz	voice2_zanH,F		;???????????
		goto	playback2_1		;????????
		retlw	1			;???????????

;?????????
playback2_1	lsrf	voice2_ptH,W		;?????????????????????
		banksel	EEADRH			;BANK??
		movwf	EEADRH			;?EEP????????????
		banksel	VOICE_BANK		;?????????BANK??
		rrf	voice2_ptL,W		;?????????????????????
		banksel	EEADRL			;BANK??
		movwf	EEADRL			;?EEP????????????
		bcf	EECON1,EECFGS		;Config??????
		bsf	EECON1,EEPGD		;Program???????
		bsf	EECON1,RD		;?????
		nop
		nop
		lslf	EEDATL,F		;???????
		rlf	EEDATH,W		;???7?????????
		banksel	VOICE_BANK		;?????????BANK??
		movwf	voice2_data		;???????????????

;??(??????)???
		banksel	EEDATL			;BANK??
		movfw	EEDATL			;?????????????????
		banksel	VOICE_BANK		;?????????BANK??
		bsf	voice2_ptL,0		;??????????
		goto	playback2_5

;??(??????)???
playback2_3	lslf	voice2_data,W		;????????????????????

;??????????
		incfsz	voice2_ptL,F		;???????
		decf	voice2_ptH,F		;???
		incf	voice2_ptH,F		;????

;PWM???????????
playback2_5	CALLCNV	voice_cnv

;?????????????
#if VOICE2_VOL==25
		movwf	voice_out		;1/4???????????
		lsrf	voice_out,F
		lsrf	voice_out,F
#else
#if VOICE2_VOL==50
		movwf	voice_out		;1/2???????????
		lsrf	voice_out,F
#else
#if VOICE2_VOL==75
		movwf	voice_out		;3/4???????????
		lsrf	voice_out,F		;1/2?
		lsrf	voice_out,W		;?1/4?
		addwf	voice_out,F		;???
#else
#if VOICE2_VOL==100
		movwf	voice_out		;1/1??????
#else
		movwf	mul_b			;???(7???????)?
		movlw	PWM_CT*VOICE0_VOL/100	;????????(8????)?
		movwf	mul_a
		call	mul7_exe		;?????
		movfw	mul_cH			;??(15???????)???8?????
		movwf	voice_out		;???????????
#endif
#endif
#endif
#endif
		retlw	0			;???????????
#endif


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;8????×8???????8????×7?????????(??????)
;input mul_a:8??????(??????????????)
;      mul_b:8???????7??????(???????????????7???????????)
;output mul_cH:?????mul_cL:????(mul_b?7?????????15????????)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
mul8_exe	movlw	8			;mul_b?8????????????
		goto	mul2
mul7_exe	movlw	7			;mul_b?7????????????
mul2		movwf	mul_wk			;??b???????????????
		clrf	mul_cH			;?????????
		clrf	mul_cL
mul5		movfw	mul_a			;??a?????
		bcf	STATUS,C		;?????????????
		btfss	mul_b,0			;??b?????????0????
		goto	mul8			;???
		addwf	mul_cH,F		;????a?????
mul8		rrf	mul_cH,F		;?????????????
		rrf	mul_cL,F
		lsrf	mul_b,F			;??b??????
		decfsz	mul_wk,F		;??b????????
		goto	mul5			;?????
		return


#if CNV_PAGE>0
		org	CNV_PAGE
#endif



